# File: expeditor-spec.txt
# Purpose: Define the exact transformations performed by the expeditor stage
#          in the CRT bottom-runner pipeline. The expeditor is a pure
#          in-memory transformer. It does NOT call any external APIs and
#          does NOT read/write Items/Docs paths.

------------------------------------------------------------
0. Overview
------------------------------------------------------------
Expeditor receives TWO raw inputs from Rows:

A) competition_payload (parsed JSON)
B) destination_payload (parsed JSON)

Expeditor MUST produce TWO output objects IN MEMORY:

1) locale_research_input
2) bottomblock_writer_input (initial form, before locale merge)

These outputs MUST strictly follow the schemas in this file.

Expeditor MUST NOT:
- invent fields not present in CompetitionPayload
- alter naming or spelling of venue, city, state
- rewrite dates or seasons
- change place objects
- write to Items or Docs
- call any tools

------------------------------------------------------------
1. Input Requirements
------------------------------------------------------------

competition_payload MUST contain:
  - creation_id
  - span_start_date
  - span_end_date
  - span_season
  - venue_name
  - venue_acronym
  - venue_official_url
  - city
  - state
  - zone
  - lat
  - lng
  - collection_primary.zoom_leg_name

destination_payload MUST contain:
  - creation_id
  - hub_meta (may be empty)
  - stay.feature, stay.list-only
  - dine.feature, dine.list-only
  - essentials.feature, essentials.list-only

Expeditor MUST validate:
- creation_id matches for both payloads
- required fields are present
- arrays exist (empty is allowed)

If any required input is missing, expeditor returns an error object
to the runner:

{ "stage": "expeditor", "message": "..." }


------------------------------------------------------------
2. Output #1 — locale_research_input
------------------------------------------------------------

Expeditor MUST produce the following object:

locale_research_input = {
  "creation_id": competition_payload.creation_id,
  "locale_input": {
    "event_name": competition_payload.collection_primary.zoom_leg_name,
    "venue_name": competition_payload.venue_name,
    "city": competition_payload.city,
    "state": competition_payload.state,
    "zone": competition_payload.zone,
    "span_start_date": competition_payload.span_start_date,
    "span_end_date": competition_payload.span_end_date,
    "span_season": competition_payload.span_season,
    "lat": number(competition_payload.lat),
    "lng": number(competition_payload.lng)
  }
}

Rules:
- All fields MUST be copied exactly, except lat/lng must be coerced to numbers.
- If span_season is empty or missing, use "could-not-verify".
- City/state spelling MUST NOT be changed from input.
- No additional fields allowed.


------------------------------------------------------------
3. Output #2 — bottomblock_writer_input (initial)
------------------------------------------------------------

Expeditor MUST produce:

bottomblock_writer_input = {
  "creation_id": competition_payload.creation_id,

  "identity": {
    "venue_name": competition_payload.venue_name,
    "venue_acronym": competition_payload.venue_acronym,
    "city": competition_payload.city,
    "state": competition_payload.state,
    "span_season": competition_payload.span_season,
    "span_start_date": competition_payload.span_start_date,
    "span_end_date": competition_payload.span_end_date,
    "zoom_leg_name": competition_payload.collection_primary.zoom_leg_name,
    "venue_official_url": competition_payload.venue_official_url,
    "lat": number(competition_payload.lat),
    "lng": number(competition_payload.lng)
  },

  "hub_meta": {
    "hub_title_override": destination_payload.hub_meta.hub_title_override
      OR ""
  },

  "stay": {
    "feature": normalize_places_array(destination_payload.stay.feature),
    "list_only": normalize_places_array(destination_payload.stay["list-only"])
  },

  "dine": {
    "feature": normalize_places_array(destination_payload.dine.feature),
    "list_only": normalize_places_array(destination_payload.dine["list-only"])
  },

  "essentials": {
    "feature": normalize_places_array(destination_payload.essentials.feature),
    "list_only": normalize_places_array(destination_payload.essentials["list-only"])
  },

  "locale_research": null  # populated after researcher stage
}

Rules:
- Expeditor must pass through place objects unchanged EXCEPT:
  - lat/lng must be coercible to numbers
  - no field renaming allowed
  - editorial_overview is preserved
- If hub_meta is missing entirely: set hub_meta = { "hub_title_override": "" }
- If price_band, price_level, editorial_overview are empty strings, they remain empty strings.
- list-only → list_only (rename required).
- All other place object fields MUST be preserved EXACTLY.


------------------------------------------------------------
4. Validation Rules
------------------------------------------------------------

Expeditor MUST validate:

- competition_payload.creation_id === destination_payload.creation_id
- competition_payload.venue_name exists
- competition_payload.city exists
- competition_payload.state exists
- competition_payload.lat/lng are parseable numbers
- destination_payload.stay/dine/essentials contain arrays:
    feature: array (may be empty)
    list-only: array (may be empty)

If any check fails:
  Return:
    { "stage": "expeditor", "message": "..." }


------------------------------------------------------------
5. Internal Helpers
------------------------------------------------------------

normalize_places_array(inputArray):
  - If inputArray is missing → return []
  - For each item:
      - lat = number(lat)
      - lng = number(lng)
      - Keep ALL other fields unchanged
  - Return the transformed array.


------------------------------------------------------------
6. No Drift, No Invention
------------------------------------------------------------

Expeditor MUST:
- never rename fields other than list-only → list_only
- never add new attributes
- never infer missing venue/city/state
- never reorder fields inside a place object
- never modify editorial_overview or descriptive text
- never "correct" website URLs or place_ids
- never fabricate a season, event name, or zone

All outputs MUST remain strict copies of inputs except:
- numeric coercion for lat/lng
- required structural reorganization described above


------------------------------------------------------------
7. Handoff to Runner
------------------------------------------------------------

Expeditor returns BOTH objects to the runner as:

{
  "locale_research_input": {...},
  "bottomblock_writer_input": {...}
}

These objects are then passed to Stage 3 (research)
and Stage 4 (writer).
