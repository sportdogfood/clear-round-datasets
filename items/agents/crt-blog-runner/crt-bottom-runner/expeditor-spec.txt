# File: expeditor-spec.txt
# Runner: CRT bottom-runner — EXPEDITOR SPEC
# Version: v2025-12-02T14:10ET — Bottom-Runner-Only

You are defining the EXPEDITOR STAGE for CRT bottom-runner.

This file describes ONLY:
- Inputs (Rows payloads),
- Normalization rules,
- Output JSON shapes for:
  - locale-research-input.json
  - bottomblock-writer-input.json
- Forbidden behaviors.

All truth, schema, and pipeline rules are governed by instructions.txt.
This spec must match instructions-mini.txt and instructions.txt exactly.

============================================================
1. ROLE OF EXPEDITOR
============================================================
Expeditor is STAGE 2 in the bottom-runner pipeline:

  LOAD → EXPEDITOR → LOCALE RESEARCHER →
  WRITER → REWRITER → COMMIT

Its job is purely mechanical:

- Read CompetitionPayload + DestinationPayload for ONE creation_id.
- Validate that creation_id matches in both payloads.
- Normalize fields using unified fallback rules.
- Emit TWO JSON files in the exact shapes required by:
  - Locale Researcher (locale-research-input.json)
  - Writer       (bottomblock-writer-input.json)

Expeditor MUST NOT:
- Perform any research or external lookups.
- Invent or “upgrade” real-world facts.
- Generate narrative or editorial content.
- Modify curated place IDs or add/remove rows.

============================================================
2. INPUTS (from Rows)
============================================================

2.1 CompetitionPayload (CP)
Required fields before normalization:

- creation_id
- venue_name
- venue_acronym
- city
- state
- zone
- span_season
- span_season_city_slug
- zoom_season
- zoom_season_city_slug
- span_start_date
- span_end_date
- zoom_start_date
- zoom_end_date
- place_id
- lat
- lng

2.2 DestinationPayload (DP)
Required fields before normalization:

- creation_id
- hub_meta.hub_title_override
- stay.feature[] / stay["list-only"][]
- dine.feature[] / dine["list-only"][]
- essentials.feature[] / essentials["list-only"][]

Expeditor MUST STOP with an error if:
- Either payload is missing or unreadable.
- creation_id does not match between CP and DP.

(LOAD/STOP behavior is fully defined in instructions.txt; this spec
only restates the requirement for expeditor inputs.)

============================================================
3. NORMALIZATION RULES
============================================================

All normalization happens ONLY in Expeditor.

3.1 Scalar text fields (CP + DP)
For ANY scalar text field that Expeditor uses:

- If the value is missing, null, or "":
  - Replace with the sentinel: "could-not-verify".

Expeditor MUST NOT:
- Replace non-empty text with "could-not-verify".
- Invent replacement values.

3.2 lat / lng (from CP)
- If lat or lng is a valid numeric value:
  - Keep as number.
- If lat or lng is missing, non-numeric, or invalid:
  - Set that field to null.

3.3 Arrays in DP
For each lane (stay, dine, essentials):

- feature arrays:
  - If missing → set to [].
- list arrays:
  - If key "list-only" is missing → treat as [].
  - If key exists but is empty → keep [].

3.4 Key mapping: list-only → list_only
DestinationPayload is allowed to use the Rows key:

- "list-only"

Expeditor MUST output writer input using ONLY:

- "list_only"

This is the ONLY allowed key rename for DP:

- stay["list-only"]   → stay.list_only
- dine["list-only"]   → dine.list_only
- essentials["list-only"] → essentials.list_only

All other keys must be preserved as-is.

============================================================
4. OUTPUT 1: locale-research-input.json
============================================================

Expeditor MUST produce locale-research-input.json with the shape:

{
  "creation_id": "<cid>",
  "event_identity": {
    "venue_name": "...",
    "venue_acronym": "...",
    "city": "...",
    "state": "...",
    "zone": "...",
    "span_season": "...",
    "span_season_city_slug": "...",
    "zoom_season": "...",
    "zoom_season_city_slug": "...",
    "span_start_date": "...",
    "span_end_date": "...",
    "zoom_start_date": "...",
    "zoom_end_date": "..."
  },
  "maps_anchor": {
    "place_id": "...",
    "lat": <number|null>,
    "lng": <number|null>
  }
}

Rules:

- All scalar text fields MUST already follow the scalar rule:
  - empty/missing/null → "could-not-verify".
- lat/lng MUST be:
  - number OR null (never "", never "could-not-verify").
- creation_id MUST match the CP/DP creation_id.

Expeditor MUST NOT:
- Drop any of the event_identity keys listed above.
- Insert extra keys not defined in instructions.txt.

============================================================
5. OUTPUT 2: bottomblock-writer-input.json
============================================================

Expeditor MUST produce bottomblock-writer-input.json with the shape:

{
  "creation_id": "<cid>",
  "hub_meta": {
    "hub_title_override": "..."
  },
  "stay": {
    "feature":   [ /* curated place rows */ ],
    "list_only": [ /* curated place rows */ ]
  },
  "dine": {
    "feature":   [ /* curated place rows */ ],
    "list_only": [ /* curated place rows */ ]
  },
  "essentials": {
    "feature":   [ /* curated place rows */ ],
    "list_only": [ /* curated place rows */ ]
  }
}

Rules:

- creation_id:
  - MUST match CP/DP creation_id.
- hub_meta.hub_title_override:
  - If empty/missing/null in DP → "could-not-verify".
- stay/dine/essentials:
  - feature and list_only MUST exist and be arrays:
    - [] if no rows.
- Place rows:
  - Each row MUST preserve all curated DP fields exactly,
    except for:
    - scalar empty → "could-not-verify" (as per Section 3.1).
  - No added or removed rows.
  - No changed IDs.

Expeditor MUST NOT:
- Invent new places or attributes.
- Reorder or filter place rows in a way that changes meaning,
  unless explicitly defined in instructions.txt (normally, no).

============================================================
6. LOGGING CONTRACT (NAMES ONLY)
============================================================

Expeditor is responsible for PRODUCING these two filenames
for downstream logging:

- {creation_id}-locale-research-input.json
- {creation_id}-bottomblock-writer-input.json

The runner’s COMMIT stage (not Expeditor itself) will write them under:

- docs/runner/bottom/logs/{creation_id}-locale-research-input.json
- docs/runner/bottom/logs/{creation_id}-bottomblock-writer-input.json

File names here MUST stay in sync with instructions.txt and any
runner logic that references them.

============================================================
7. FORBIDDEN BEHAVIORS
============================================================

Expeditor MUST NOT:

- Call any external APIs or tools.
- Perform any web search or locale research.
- Fabricate or “upgrade” real-world facts.
- Change curated IDs or remove/insert place rows.
- Alter JSON structure beyond:
  - scalar fallback → "could-not-verify",
  - lat/lng → null,
  - arrays → [],
  - "list-only" → "list_only".

If CP/DP are invalid beyond these normalizations, Expeditor MUST
surface an error for the LOAD/validation stage to STOP the pipeline.

============================================================
END OF FILE
============================================================
