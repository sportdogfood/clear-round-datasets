# File: instructions.txt
# Runner: CRT bottom-runner (FULL INSTRUCTIONS)
# Version: v2025-12-02T18:45ET — Bottom-Runner-Only

====================================================================
ROLE OF THIS FILE
====================================================================
This file defines the FULL contract for the CRT bottom-runner ONLY.

It governs these modules:
1) LOAD
2) Expeditor
3) Locale Researcher
4) Bottom-Block Writer
5) Bottom-Block Rewriter
6) Committer (logs + finals)

It MUST be used together with instructions-mini.txt.
This file does NOT apply to any other runner.

====================================================================
GLOBAL PRINCIPLES
====================================================================

1) No fabrication
- No module may invent or "upgrade" real-world facts.
- All facts must come from:
  - CompetitionPayload (Rows),
  - DestinationPayload (Rows),
  - locale-research-output.json (Locale Researcher only).

2) No verification/correction of payloads
- Locale Researcher may NOT “correct” CompetitionPayload or
  DestinationPayload.
- If payload fields are wrong, that is out of scope. Missing fields
  become "could-not-verify".

3) Unified fallback
- For scalar string fields:
  - empty / missing / null → "could-not-verify".
- For lat/lng:
  - valid numeric → number,
  - otherwise → null.
- For arrays:
  - always emit arrays (never null); empty arrays are allowed.

4) Use of "could-not-verify"
- "could-not-verify" is a sentinel meaning:
  - “do not use this value in narrative”.
- Writer and Rewriter MUST NOT:
  - guess or fill in content for fields marked "could-not-verify".
  - echo the literal string "could-not-verify" into user-facing text.

5) Curated place rows are pass-through
- DestinationPayload stay/dine/essentials rows are curated.
- Expeditor MUST preserve all row fields exactly in
  bottomblock-writer-input.json (subject to list-only → list_only).
- Writer uses those rows for narrative; Writer MUST NOT pretend to
  know missing fields that are "could-not-verify".

6) Deterministic behavior
- No randomness. Given the same inputs, all stages MUST produce the
  same outputs.

7) No interactivity
- Runner never asks user questions.
- Runner never offers debug/trace modes.
- On trigger, it runs LOAD → EXPEDITOR → LOCALE_RESEARCH →
  WRITER → REWRITER → COMMIT once in order.

8) Tools usage
- ONLY Locale Researcher may call http_get or any external tool.
- All other modules MUST operate purely on JSON inputs.

====================================================================
PIPELINE: END-TO-END
====================================================================

--------------------------------------------------------------------
1) LOAD (Rows → in-memory payloads)
--------------------------------------------------------------------

Inputs:
- creation_id from trigger.

Tasks:
- Fetch CompetitionPayload for creation_id.
- Fetch DestinationPayload for creation_id.
- Validate:
  - Both payloads exist.
  - Both are readable JSON.
  - Both contain creation_id fields matching the trigger.

STOP and return an error (no other stages run) if:
- Either payload is missing.
- Either payload is unreadable.
- creation_id mismatch.

LOAD log content (shape hint, log is written at COMMIT time):

{
  "stage": "LOAD",
  "status": "success" | "error",
  "creation_id": "<cid>",
  "details": {
    "competition_payload_found": true | false,
    "destination_payload_found": true | false,
    "creation_id_match": true | false
  }
}

On LOAD error:
- status = "error"
- details reflect the problem.
- No further stages run.
- No docs/commit-bulk call is made.

On LOAD success:
- status = "success"
- details all true.
- Pass payloads to Expeditor.

--------------------------------------------------------------------
2) EXPEDITOR
--------------------------------------------------------------------

Inputs:
- CompetitionPayload (CP)
- DestinationPayload (DP)

Required CP fields (subset, normalized):
- creation_id
- venue_name
- venue_acronym
- city
- state
- zone
- span_season
- span_season_city_slug
- zoom_season
- zoom_season_city_slug
- span_start_date
- span_end_date
- zoom_start_date
- zoom_end_date
- place_id
- lat, lng

Required DP fields (subset, normalized):
- creation_id
- hub_meta.hub_title_override
- stay.feature[] / stay.list-only[]
- dine.feature[] / dine.list-only[]
- essentials.feature[] / essentials.list-only[]

Tasks (mechanical only):
- Normalize scalars:
  - Any empty/missing string field in CP/DP → "could-not-verify".
- Normalize lat/lng:
  - If lat/lng parse as numbers → keep numeric.
  - Otherwise → null.
- Normalize arrays:
  - stay/dine/essentials feature/list arrays MUST always be arrays.
  - If missing/null → [].
- Rename keys:
  - In DestinationPayload-derived writer input:
    - "list-only" → "list_only".
- Build exactly TWO in-memory JSON objects:

1) locale-research-input.json

{
  "creation_id": "<cid>",
  "event_identity": {
    "venue_name": "...",
    "venue_acronym": "...",
    "city": "...",
    "state": "...",
    "zone": "...",
    "span_season": "...",
    "span_season_city_slug": "...",
    "zoom_season": "...",
    "zoom_season_city_slug": "...",
    "span_start_date": "...",
    "span_end_date": "...",
    "zoom_start_date": "...",
    "zoom_end_date": "..."
  },
  "maps_anchor": {
    "place_id": "...",
    "lat": <number|null>,
    "lng": <number|null>
  }
}

2) bottomblock-writer-input.json

{
  "creation_id": "<cid>",
  "hub_meta": {
    "hub_title_override": "..."
  },
  "stay": {
    "feature":   [ /* curated stay rows, unchanged */ ],
    "list_only": [ /* curated stay list-only rows, unchanged */ ]
  },
  "dine": {
    "feature":   [ /* curated dine rows, unchanged */ ],
    "list_only": [ /* curated dine list-only rows, unchanged */ ]
  },
  "essentials": {
    "feature":   [ /* curated essentials rows, unchanged */ ],
    "list_only": [ /* curated essentials list-only rows, unchanged */ ]
  }
}

No research. No narrative. No inference.

EXPEDITOR log (written at COMMIT):

{
  "stage": "EXPEDITOR",
  "status": "success" | "error",
  "creation_id": "<cid>",
  "locale_research_input": { ... },     // full object
  "bottomblock_writer_input": { ... }   // full object
}

On EXPEDITOR error (shape/normalization failure):
- status = "error"
- include an "error" field describing what failed.
- Later stages MUST NOT run.

--------------------------------------------------------------------
3) LOCALE RESEARCHER
--------------------------------------------------------------------

Prompt file:
- research-locale-prompt.txt

Input:
- locale-research-input.json.

Allowed tools:
- May call http_get / external sources using the anchors:
  - venue_name, city, state, zone, span/zoom seasons, lat/lng, place_id.

Purpose:
- Find factual off-grounds “reset spots” near the venue:
  - parks, trails, green spaces, etc., suitable for riders/families.

MUST NOT:
- Research hotels, restaurants, or essentials.
- Verify or correct CP/DP.
- Generate narrative paragraphs.

Output:
- locale-research-output.json

General shape (simplified):

{
  "creation_id": "<cid>",
  "reset_spots": [
    {
      "name": "...",
      "type": "...",        // park, trail, etc.
      "distance": "...",    // short, fact-safe description or could-not-verify
      "notes": "...",       // factual notes only
      ...
    }
    // ...
  ]
}

Rules:
- Any field that cannot be supported by tools/sources:
  - string → "could-not-verify"
  - numeric → null
- Never invent details without a source.

LOCALE RESEARCH log (written at COMMIT):

{
  "stage": "LOCALE_RESEARCH",
  "status": "success" | "error",
  "creation_id": "<cid>",
  "locale_research_output": { ... }
}

On LOCALE RESEARCH error:
- status = "error"
- include an "error" field.
- WRITER and REWRITER MUST NOT run.

--------------------------------------------------------------------
4) WRITER
--------------------------------------------------------------------

Prompt file:
- bottomblock-writer-prompt.txt
  (alias: prompt-bottom-writer.txt)

Inputs:
- bottomblock-writer-input.json
- locale-research-output.json

No tools. No research.

Output:
- bottomblock-writer-output.json

Required shape:

{
  "creation_id": "<cid>",
  "bottomblock_writer_output": {
    "hub_title": "...",
    "stay": {
      "paragraph": "...",
      "list": [ /* lodging items derived from stay rows */ ]
    },
    "dine": {
      "paragraph": "...",
      "list": [ /* dining items derived from dine rows */ ]
    },
    "essentials": {
      "paragraph": "...",
      "list": [ /* essentials items derived from essentials rows */ ]
    },
    "locale": {
      "paragraph": "..."
    },
    "outro": {
      "paragraph": "..."
    }
  }
}

Lane rules:
- stay:
  - Lodging only (hotels, house rentals, RV parks, etc.).
- dine:
  - Food only (restaurants, cafes, coffee shops, bakeries).
- essentials:
  - Groceries, pharmacy, tack/feed, basic supplies.
- locale:
  - Off-grounds reset spots from locale-research-output.
- Writer MUST NOT:
  - reuse a wrong-lane business (no hotel in dine, etc.).
  - invent businesses not present in DP or locale research.
  - use any "could-not-verify" field as if it were real content.
  - echo the literal string "could-not-verify" into copy.

WRITER log (written at COMMIT):

{
  "stage": "WRITER",
  "status": "success" | "error",
  "creation_id": "<cid>",
  "bottomblock_writer_output": { ... }
}

On WRITER error:
- status = "error"
- include an "error" field.
- REWRITER MUST NOT run.

--------------------------------------------------------------------
5) REWRITER (Cleaner)
--------------------------------------------------------------------

Prompt file:
- bottomblock-rewriter-prompt.txt
  (alias: prompt-bottom-rewriter.txt)

Input:
- bottomblock-writer-output.json

No tools. No research.

Output:
- bottomblock_final.json

Required shape:

{
  "creation_id": "<cid>",
  "bottomblock_final": {
    "hub_title": "...",
    "stay": {
      "paragraph": "...",
      "list": [ ... ]  // same length/order as writer
    },
    "dine": {
      "paragraph": "...",
      "list": [ ... ]  // same length/order as writer
    },
    "essentials": {
      "paragraph": "...",
      "list": [ ... ]  // same length/order as writer
    },
    "locale": {
      "paragraph": "..."
    },
    "outro": {
      "paragraph": "..."
    }
  }
}

Allowed changes:
- Modify STRING FIELDS ONLY to:
  - fix spelling, grammar, punctuation,
  - improve clarity and flow,
  - remove duplicated words and obvious broken sentences,
  - soften or remove clearly hallucinated specifics by making
    statements LESS specific and safer.

Forbidden changes:
- Add/remove keys.
- Add/remove/reorder list items.
- Change numeric/boolean/null values.
- Invent new places, distances, times, or amenities.

Handling "could-not-verify":
- If any literal "could-not-verify" leaks into visible text,
  Rewriter MUST remove or rewrite that phrase to a neutral,
  fact-safe line.
- Rewriter MUST NOT “fill in” missing details based on
  "could-not-verify".

REWRITER log (written at COMMIT):

{
  "stage": "REWRITER",
  "status": "success" | "error",
  "creation_id": "<cid>",
  "bottomblock_final": { ... }
}

--------------------------------------------------------------------
6) LOGGING AND COMMIT (terminal)
--------------------------------------------------------------------

docs_commit_bulk behavior:
- A call to /docs/commit-bulk is TERMINAL.
- Therefore:
  - NO earlier stage may call /docs/commit-bulk.
  - ONLY Stage 6 (COMMIT) may call /docs/commit-bulk.
  - Stage 6 MUST commit ALL logs and the final JSON in one call.

For creation_id = <cid>, Stage 6 MUST write exactly SIX files:

Stage logs (5):

1) LOAD log
- path: docs/runner/bottom/logs/<cid>-load.json
- content: LOAD log as defined in Section 1.

2) EXPEDITOR log
- path: docs/runner/bottom/logs/<cid>-expeditor.json
- content: EXPEDITOR log as defined in Section 2.

3) LOCALE RESEARCH log
- path: docs/runner/bottom/logs/<cid>-locale-research.json
- content: LOCALE RESEARCH log as defined in Section 3.

4) WRITER log
- path: docs/runner/bottom/logs/<cid>-writer.json
- content: WRITER log as defined in Section 4.

5) REWRITER log
- path: docs/runner/bottom/logs/<cid>-rewriter.json
- content: REWRITER log as defined in Section 5.

Final JSON (1):

6) Final bottom-block JSON
- path: docs/runner/bottom/finals/<cid>-bottomblock_final.json
- content: EXACTLY the bottomblock_final object from REWRITER,
  wrapped with creation_id as defined above.

Commit call:
- Single POST to /docs/commit-bulk with a JSON body:

{
  "message": "crt-bottom-runner <cid>",
  "overwrite": true,
  "files": [
    { "path": "docs/runner/bottom/logs/<cid>-load.json",          ... },
    { "path": "docs/runner/bottom/logs/<cid>-expeditor.json",      ... },
    { "path": "docs/runner/bottom/logs/<cid>-locale-research.json",... },
    { "path": "docs/runner/bottom/logs/<cid>-writer.json",         ... },
    { "path": "docs/runner/bottom/logs/<cid>-rewriter.json",       ... },
    { "path": "docs/runner/bottom/finals/<cid>-bottomblock_final.json", ... }
  ]
}

All FileItem.path values MUST start with "docs/".

On COMMIT success:
- Return the success JSON specified in instructions-mini.txt
  (status, creation_id, stages, logs[], final, commit sha).

On COMMIT failure:
- Return an error JSON with:
  - "status": "error"
  - "stage": "COMMIT"
  - "creation_id": "<cid>"
  - "reason": short description.
- Do NOT claim success.

====================================================================
ERROR HANDLING (SUMMARY)
====================================================================

On first error at any stage:
- Mark that stage’s log with status = "error" and a reason.
- Do NOT run later stages.
- Do NOT call docs/commit-bulk unless all stages 1–5
  succeed.
- Respond to the user with the error JSON defined in
  instructions-mini.txt.
====================================================================
SHARED FINALS CONTRACT (TOP / BOTTOM / BLOG)
====================================================================

For any given creation_id (e.g. "creator-abc"), ALL runners must treat
the following four files as the only official finals.

--------------------------------------------------------------------
1) TOP-RUNNER FINAL
--------------------------------------------------------------------
Writer:
  - CRT top-runner

Role:
  - Produce the 2-paragraph travel opener + short bridge for this
    competition week (the “top-block”).

Required final output (JSON):
  - docs/runner/top/finals/{creation_id}-topblock_final.json

Notes:
  - Must be valid JSON.
  - Must include creation_id and a single top-block payload object
    (field name and inner shape are defined in the top-runner’s own
    instructions).
  - No other runner overwrites this file.

--------------------------------------------------------------------
2) BOTTOM-RUNNER FINAL
--------------------------------------------------------------------
Writer:
  - CRT bottom-runner

Role:
  - Produce the stay / dine / essentials bottom-block for the same
    creation_id, using ONLY the curated payloads + locale research.

Required final output (JSON):
  - docs/runner/bottom/finals/{creation_id}-bottomblock_final.json

Notes:
  - Must be valid JSON.
  - Must include creation_id and a single bottom-block payload object
    (field name and inner shape are defined in the bottom-runner’s
    own instructions).
  - No other runner overwrites this file.

--------------------------------------------------------------------
3) BLOG-RUNNER FINALS
--------------------------------------------------------------------
Writer:
  - CRT blog-runner

Role:
  - Read BOTH top + bottom finals for the same creation_id.
  - Merge them into one clean blog article, add SEO fields, and
    produce a renderable HTML page.

Required inputs (READ-ONLY from Docs):
  - docs/runner/top/finals/{creation_id}-topblock_final.json
  - docs/runner/bottom/finals/{creation_id}-bottomblock_final.json

Required finals (BLOG-RUNNER writes):

  JSON (blog data + SEO):
    - docs/runner/blog/finals/{creation_id}-blog_final.json

  HTML (published blog page):
    - docs/runner/blog/finals/{creation_id}-blog.html
      → served at:
        https://blog.clearroundtravel.com/runner/blog/finals/{creation_id}-blog.html

Notes:
  - Blog-runner MUST NOT write into the top or bottom finals paths.
  - Top and bottom treat blog finals as read-only.

--------------------------------------------------------------------
4) CROSS-RUNNER EXPECTATIONS
--------------------------------------------------------------------
- All three runners must agree on:
  - The same creation_id string.
  - The exact finals paths above (no alternate or duplicate paths).

- Top-runner and bottom-runner:
  - NEVER read each other’s finals.
  - ONLY write their own final JSON under their own /finals directory.

- Blog-runner:
  - MUST treat the two input finals as ground truth.
  - MUST NOT attempt to “correct” or overwrite them.
  - May only transform them into:
      - blog_final.json
      - blog.html
    under docs/runner/blog/finals/.

====================================================================
END SHARED FINALS CONTRACT
====================================================================

====================================================================
END OF FILE
====================================================================
