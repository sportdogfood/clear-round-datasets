# CRT List-Runner

Tight, small-world packing system for equestrian shows.  
Voice-first, mobile-first, Git-backed, no drift.

---

## 1. Scope

Single responsibility:

- Track what goes to each show and what comes back.
- Work over a very small, explicit dataset.
- Be deterministic and inspectable via JSON in GitHub.

No weather, no chat, no general assistant behavior.

---

## 2. Runtime

### Proxy

`server.js` exposes a minimal HTTP surface:

- `GET  /health`  
- `GET  /items/{path}`  
  - Read-only proxy to `items/*` on the upstream repo (safe extensions only).
- `POST /items/commit`  
  - Commit a single `items/*` file via GitHub contents API.
- `POST /items/commit-bulk`  
  - Bulk commit multiple `items/*` files in one Git commit.
- `POST /items/agents/list-runner/command`  
  - Only write surface for List-Runner behavior.
- `GET  /items/agents/list-runner/state`  
  - Read-only snapshot for mobile/voice clients.

### Env

Required:

- `UPSTREAM_BASE` (raw base for reads)
- `GITHUB_REPO`
- `GITHUB_BRANCH` (default `main`)
- `GITHUB_TOKEN`

All writes go through this proxy. No direct GitHub calls from clients.

---

## 3. Directory layout (List-Runner)

All paths under:

`items/agents/list-runner/`

### 3.1 Canonical libs (source of truth)

`lib/locations_lib.json`  
`lib/shows_lib.json`  
`lib/horses_lib.json`  
`lib/items_lib.json`  
`lib/lists_lib.json`  
`lib/kits_lib.json`  
`lib/language_lib.json`   (outside language lane)  
`lib/voice_profile.json`  (response style for Runner)

These define:

- IDs and canonical names.
- Aliases, misspells, nicknames, translations.
- Tags and bin hints for home/away.
- Optional kits as syntactic sugar (expand into lines, no binding).

### 3.2 Operational state

`lists/started_lists.json`  
- Active packing lists and their lines.

`lists/archived_lists.json`  
- Archived lists (e.g. shows older than N days).

`lists/index.json`  
- Derived index for fast lookups (generated by expeditor).

`state.json`  
- Thin global: last device, last actor, last command, current focus, etc.

### 3.3 Logs

`logs/updates.json`  
- One entry per command: parsed intent, affected entities, result.

`logs/transactions.json`  
- Thin, explicit record of transfers / adjustments tied to lists and items.

All of the above are maintained only through `/items/agents/list-runner/command`
plus `expeditor.js` (see below).

---

## 4. List-Runner command API

`POST /items/agents/list-runner/command`

- Input:
  - `device_id` (required)
  - `actor` (optional display label)
  - `command` (optional natural language)
  - `intent` (optional structured; if present, takes priority)
  - `now` (optional ISO timestamp; server can default)
- Responsibilities:
  - Use `*_lib.json` to resolve:
    - show, list, horse, item, kit, location, language intent.
  - Select the correct active list(s) from `started_lists.json`.
  - Apply exactly one atomic operation per call:
    - `add_line`:
      - Add inventory line or misc/non-inventory line to a target list.
    - `set_status`:
      - Update `to_take` / `to_bring_home` / special states
        (`missing`, `broken`, `left_over`, `sent_back_early`, `not_needed`, `reset`).
    - `add_comment`:
      - Append a note/comment line linked to a list.
    - `apply_kit`:
      - Expand a kit (from `kits_lib.json`) into concrete lines immediately.
    - `summary`, `show_list`:
      - Read-only, no mutations.
  - Persist on success via `/items/commit-bulk`:
    - `lists/started_lists.json`
    - `lists/archived_lists.json` (when rules trigger)
    - `state.json`
    - `logs/updates.json`
    - `logs/transactions.json`
  - Run `items/agents/list-runner/expeditor.js` to refresh `lists/index.json`
    and any other derived artifacts.

The endpoint is **strictly scoped**:
only acts within known libs, lists, and states.

---

## 5. State API

`GET /items/agents/list-runner/state`

Returns a compact snapshot for clients:

- Lib excerpts needed for UI (shows, horses, lists, items, kits, locations).
- Active lists and their lines from `started_lists.json`.
- Useful counts / status summaries.

No writes. No archive or log changes.

---

## 6. Outside language lane

`language_lib.json`:

- Declares:
  - supported intents and patterns,
  - synonyms for actions (`pack`, `bring`, `what's left`, etc.),
  - mapping of phrases â†’ structured intent hints.
- Used by:
  - the GPT config,
  - or a thin client parser,
  - to keep recognition inside this small world.

`voice_profile.json`:

- Defines short, clear, rider-friendly response style:
  - one-line answers when possible,
  - always mention show/list/item context,
  - no off-topic content.

Optional client-side fuzzy search (e.g. Fuse.js) can be used over:
- names, aliases, misspells in `*_lib.json`.
The HTTP API and JSON shapes remain independent of any CDN/plugin.

---

## 7. Expeditor

`items/agents/list-runner/expeditor.js` (not shown here):

- Consumes canonical + state + logs.
- Regenerates:
  - `lists/index.json`
  - any other lightweight derived views.
- Called only after successful `/command` commits.

---

## 8. Rules of engagement

- All canonical edits go through this proxy.
- `/items/agents/list-runner/command` is the only mutating surface
  for List-Runner data.
- `/items/agents/list-runner/state` is the only public snapshot surface.
- Any behavior not backed by these files or routes is out-of-bounds.
