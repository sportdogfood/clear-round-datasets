PLACES CONTRACT — v2.4 (ET)
Last updated: 2025-09-07

SCOPE
- Canonical place card schema for families: hotel, airbnb, rvpark, restaurant, site, park.
- Facts-only; inputs are hints; confirm from official site (HTTPS) before write.

MUST-LOAD (FULL URLs; fail-closed)
- Manifest: https://crt-b1434e13de34.herokuapp.com/items/agents/manifest.json
- Ingestion rules: https://crt-b1434e13de34.herokuapp.com/items/agents/ingestion-rules.txt
- Place rules: https://crt-b1434e13de34.herokuapp.com/items/agents/place-rules.json
- Cards core (shared): https://crt-b1434e13de34.herokuapp.com/items/agents/cards-core.txt
- Labels rules: https://crt-b1434e13de34.herokuapp.com/items/agents/labels-rules.json

DIRS & PATHS
- Plural map: hotel→hotels, airbnb→airbnbs, rvpark→rvparks, restaurant→restaurants, site→sites, park→parks
- Write path template: items/index/{place_type_plural}/{place_uid}.json
- Allowed prefix: /items/; must match regex: ^items/index/(hotels|airbnbs|rvparks|restaurants|sites|parks)/[a-z0-9-]+\.json$

UID & FILENAME POLICY
- place_uid = slugify(place_official_name); append city/state stem on collision per rules.
- _uid for place cards = place_uid.
- Filename equals UID.

REQUIRED FIELDS
- _uid (== place_uid)
- place_uid
- place_type (one of: hotel, airbnb, rvpark, restaurant, site, park)
- place_official_name
- place_display_name
- place_official_link (HTTPS)
- city_uid, state_uid, country_uid
- source_uids (array; ≥1; domain slugs)
- created_date (ET), last_updated (ET)

OPTIONAL FIELDS
- aka[], keywords[], label_uids[]
- primary_venue_uid (ends -venue), near_venue_uids[] (ends -venue)
- place_city, place_state, place_description
- place_address_line1, place_address_line2, place_zip
- place_timezone (IANA), place_phone, place_email, place_hours_note
- place_google_pin, place_geo_lat, place_geo_long
- notes, form_uid, git_status

TYPED INPUT ALIASES (optional convenience)
- When accepted, map type-prefixed inputs (e.g., hotel_link → user_input_place_link) to canonical fields before validation.

RELATED_UIDS BLOCK (include for stitching)
- related_uids: {
    "primary_venue_uid": "…",
    "near_venue_uids": [ … ],
    "label_uids": [ … ],
    "source_uids": [ … ]
  }

SOURCES
- source_uid = domain_slug of official site; de-duplicate by domain under /items/sources.

DERIVED (allowed; never overwrite inputs)
- yyyymm (when inspection month is set elsewhere)

VALIDATION (fail-closed)
- official_link_must_be_https=true
- relations_must_resolve=true (city/state/country; venues when referenced; labels when present)
- bool_encoding=yn; date_format=YYYY-MM-DD

PREVIEW ENVELOPE (read-only)
{
  "event":"ADD_PLACE_PREVIEW",
  "status":"ok|error",
  "path":"items/index/<family>/<place_uid>.json",
  "message":"add: <Place Display Name> (<city/state>)",
  "json": { /* complete place card (fields above) */ },
  "sources_checked":[ {"url":"<final_url>","source_uid":"<domain-slug>","is_official":"y"} ],
  "load_ledger":[ {"url":"…/boot.json","status":"ok"}, {"url":"…/place-rules.json","status":"ok"} ],
  "timestamp":"ISO-8601"
}

COMMIT ENVELOPE (full-drop only)
- JSON: { "path": "https://…/items/index/{family_plural}/{place_uid}.json", "message": "add: …", "json": { … } }

FAILURE MODES
- needs_rules | needs_source | needs_review | needs_normalizer | invalid_path | validation_failed

END
