# manifest-contract.txt
# Clear Round Travel — Kernel & Agents
# Version: v1
# Last updated: 2025-09-01

Purpose
-------
Authoritative description of what the dataset manifest controls and what it does not.
This is a docs-only contract for humans and tools (proxy, kernel, Codex).

Where it lives
--------------
Path: index/agents/manifest.json  (read by the proxy and referenced by tooling)

Non-goal (important)
--------------------
Adding or modifying agents/tasks does NOT require changes to this manifest.
The kernel loads tasks by folder convention (see operating-rules.txt).

What the manifest governs (summary)
-----------------------------------
- Repository I/O endpoints (proxy_base, git_base)
- Default branch and PR settings (optional)
- Write allowlist (paths that may be written via proxy)
- Read scope and caching hints (optional)
- Commit/PR metadata defaults (optional)

Required keys (minimum)
-----------------------
- version (string)  
  Schema version of the manifest (e.g., "v1").

- proxy_base (string, https URL)  
  Base URL for the write/read proxy (e.g., Heroku).  
  Used for commits and may be used for reads when available.

- git_base (string, https URL)  
  Raw read base for the dataset repository (e.g., GitHub raw/content API).  
  Fallback source for reads if proxy is unavailable.

- write_allowlist (array of strings)  
  Top-level repo paths that the proxy may write to (directory prefixes).  
  This SHOULD mirror the Heroku ALLOW_DIRS environment value.

Optional keys
-------------
- default_branch (string)  
  The primary branch for PRs/commits (e.g., "main").

- pr_by_default (boolean)  
  Default behavior for commits initiated by automated actors (Agent/Codex).  
  Operating default is PR; this key may reinforce that.

- pr_branch_prefix (string)  
  Prefix for auto-created PR branches (e.g., "chore/agent/").

- reviewers (array of strings)  
  Default Git usernames/teams to request on PR creation.

- read_roots (array of strings)  
  Directory prefixes the proxy/kernel should read from (advisory).

- read_cache_ttl_seconds (integer)  
  Hint for caching immutable reads to reduce rate limits.

- commit_author (object)  
  { "name": "Clear Round Bot", "email": "bot@clearround.travel" }

- message_prefix (string)  
  Text prepended to auto-generated commit messages.

Behavioral rules
----------------
- Reads:  
  1) Prefer proxy_base when available (may include caching),  
  2) Fallback to git_base for canonical content.

- Writes:  
  All writes go through the proxy and MUST target a path that starts with one of
  the write_allowlist prefixes. The proxy may additionally enforce ALLOW_DIRS from
  environment; both should match.

- Preview-first (policy):  
  PREVIEW → COMMIT is enforced at the task level (see operating-rules.txt).  
  The manifest does not waive preview; it can only set defaults (e.g., pr_by_default).

- No task enumeration:  
  The manifest does not list agents/starters. It is not a router and should not be
  edited to add or remove tasks.

Error modes (expected)
----------------------
- missing_manifest: file not found or unreadable → tools should fail safe
- invalid_manifest: required keys missing or malformed → fail safe
- allowlist_denied: target path not under write_allowlist → reject write
- upstream_error: git_base/proxy_base returned non-2xx → bubble up
(See error-codes.txt for remediation steps.)

Security & audit
----------------
- proxy_base MUST be https.  
- write_allowlist is the primary guard; keep it tight and derived from actual use.
- The proxy SHOULD stamp actor/type/timestamp in PR bodies or commit messages.

Backwards compatibility
-----------------------
- write_allowlist replaces historical ALLOW_DIRS spreadsheets; maintain parity with
  the Heroku ALLOW_DIRS env var to avoid drift.
- Tools should ignore unknown keys to allow forward evolution.

Example (minimal)
-----------------
{
  "version": "v1",
  "proxy_base": "https://crt-b1434e13de34.herokuapp.com",
  "git_base":   "https://raw.githubusercontent.com/sportdogfood/clear-round-datasets/main",
  "default_branch": "main",
  "pr_by_default": true,
  "write_allowlist": [
    "index/events/",
    "index/venues/",
    "index/event-series/",
    "items/agents/",
    "items/forms/",
    "items/stay/",
    "items/dine/",
    "items/locale/"
  ]
}

Change control
--------------
- Updates to this manifest-contract.txt are Yellow (PR required).
- Any widening of write_allowlist should be called out in the PR description.




