{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://clearroundtravel.com/specs/blog/cp-2/pipeline-spec.json",
  "file": "pipeline-spec.json",
  "version": "v2025-12-27-pipeline-09",
  "street": "blog",
  "house": "cp:2",

  "live_only": {
    "required": true,
    "mode_literal": "live",
    "halt_if_job_definition_mode_not_live": true,
    "on_fail": { "action": "halt", "error_code": "PIPE_JOB_MODE_NOT_LIVE" }
  },

  "purpose": [
    "Define deterministic live-mode lane execution for cp and ccc houses.",
    "Lanes read/write directly via injected datasets.",
    "Support iteration over multiple cdataN-* datasets when house=ccc:3."
  ],

  "structure_rules": {
    "no_virtual_bins": true,
    "no_pass_numbers": true,
    "flat_registry": true,
    "no_dynamic_builders": true,
    "templates_load_directly": true
  },

  "dataset_families": {
    "collection": {
      "prefix": "cdata",
      "description": "Event, venue, and city/season datasets (may include multiple cdataN-* when house=ccc:3)."
    },
    "places": {
      "prefix": "pdata",
      "description": "Stay, dine, essentials, and locale datasets."
    }
  },

  "templates": {
    "exp": "expeditor-contract.json",
    "cr": "member-template-cr-prompt.txt",
    "cw": "member-template-cw-prompt.txt",
    "crwtr": "member-template-crwtr-prompt.txt",
    "pr": "member-template-pr-prompt.txt",
    "pw": "member-template-pw-prompt.txt",
    "prwtr": "member-template-prwtr-prompt.txt",
    "stchr": "member-template-stchr-prompt.txt",
    "srwrtr": "member-template-srwrtr-prompt.txt",
    "commit": "commit-spec.json"
  },

  "execution_sequence": [
    "exp",
    "cr",
    "cw",
    "crwtr",
    "pr",
    "pw",
    "prwtr",
    "stchr",
    "srwrtr",
    "commit"
  ],

  "lane_registry": {
    "exp": {
      "type": "expeditor",
      "template_ref": "exp",
      "description": "Partition and register dataset roles (handled by runner).",
      "reads": ["job_definition", "datasets_by_role"],
      "writes": ["collection_input", "places_input"],
      "model_called": false
    },

    "cr": {
      "type": "researcher",
      "template_ref": "cr",
      "reads": ["collection_input"],
      "writes": ["collection_research"],
      "model_called": true,
      "loop_policy": {
        "iterate_if_family": "collection",
        "path_pattern": "datasets_by_role.collection_input.*"
      }
    },

    "cw": {
      "type": "writer",
      "template_ref": "cw",
      "reads": ["collection_research"],
      "writes": ["collection_written"],
      "model_called": true,
      "loop_policy": { "inherit_from": "cr" }
    },

    "crwtr": {
      "type": "rewriter",
      "template_ref": "crwtr",
      "reads": ["collection_written"],
      "writes": ["collection_output"],
      "model_called": true,
      "loop_policy": { "inherit_from": "cr" }
    },

    "pr": {
      "type": "researcher",
      "template_ref": "pr",
      "reads": ["places_input"],
      "writes": ["places_research"],
      "model_called": true
    },
    "pw": {
      "type": "writer",
      "template_ref": "pw",
      "reads": ["places_research"],
      "writes": ["places_written"],
      "model_called": true
    },
    "prwtr": {
      "type": "rewriter",
      "template_ref": "prwtr",
      "reads": ["places_written"],
      "writes": ["places_output"],
      "model_called": true
    },

    "stchr": {
      "type": "stitcher",
      "template_ref": "stchr",
      "reads": ["collection_output", "places_output"],
      "writes": ["stitched_output"],
      "model_called": true,
      "merge_policy": {
        "spec_file": "stitcher-merge-spec.json",
        "combine_all_collection_outputs": true,
        "combine_all_place_outputs": true
      }
    },

    "srwrtr": {
      "type": "rewriter",
      "template_ref": "srwrtr",
      "reads": ["stitched_output"],
      "writes": ["final_output"],
      "model_called": true
    },

    "commit": {
      "type": "commit",
      "template_ref": "commit",
      "reads": ["final_output"],
      "writes": [
        "docs/blog/cp-2/finals/",
        "docs/blog/cp-2/logs/"
      ],
      "model_called": false
    }
  },

  "execution_rules": {
    "strict_sequential_order": true,
    "halt_on_missing_template": true,
    "halt_on_read_failure": true,
    "halt_on_write_conflict": true,
    "require_model_for": [
      "researcher",
      "writer",
      "rewriter",
      "stitcher"
    ],
    "forbid_model_for": [
      "expeditor",
      "commit"
    ],
    "validate_output_shape_after_each_lane": true,
    "stop_if_invalid_json": true
  },

  "logging": {
    "enable_lane_logging": true,
    "log_fields": [
      "lane_key",
      "type",
      "template_ref",
      "reads",
      "writes",
      "model_called"
    ],
    "ensure_one_entry_per_lane": true,
    "require_model_called_consistency": true
  }
}
