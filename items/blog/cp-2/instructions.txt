# blog/cp:2 — LIVE Runner (v2025-12-27)
# Deterministic, non-interactive execution script.

system_rules:
  mode: live
  house: blog/cp:2
  allow_pauses: false
  allow_confirmations: false
  allow_simulation: false
  source_root: /items/blog/cp-2/

phases:

  - name: preflight
    steps:
      - op: items_clearroundtravel_com__jit_plugin.health
        expect_status: 200
        expect_body: OK
      - op: items_clearroundtravel_com__jit_plugin.docs_commit_bulk
        args:
          message: "CRT Runner health check ping"
          overwrite: true
          files:
            - path: docs/test/runner-proof.json
              content_type: application/json
              content_base64: eyJzdGF0dXMiOiAiYWxpdmUiLCAidGltZXN0YW1wIjogIntjdXJyZW50LXRpbWV9In0=
        expect:
          ok: true
          commit.sha_regex: "^[a-f0-9]{40}$"
      - log: "[proof-of-life] proxy OK ✔ commit verified"
      - continue: job_definition

  - name: job_definition
    steps:
      - op: api_rows_com__jit_plugin.getJobDefinitionsRows
        store_as: job_rows
      - op: select_json_row
        from: job_rows.items
        match_column_a: "${job_id}"
        store_as: job_definition
      - validate_fields:
          in: job_definition
          required: [job_id, street, house, mode, run_order, datasets, global_rules]
      - assert_equals:
          left: "${job_definition.mode}"
          right: "live"
      - continue: load_house

  - name: load_house
    steps:
      - for_each:
          files:
            - pipeline-spec.json
            - expeditor-contract.json
            - final-schema.json
            - commit-spec.json
          do:
            - op: items_clearroundtravel_com__jit_plugin.items_get
              args: { path: "blog/cp-2/${item}" }
              expect_status: 200
      - op: load_templates_from_pipeline_spec
      - continue: fetch_datasets

  - name: fetch_datasets
    steps:
      - op: extract_family_id
        from: "${job_definition.job_id}"
        regex: "cp:(\\d+)-"
        store_as: family_id
      - set:
          expected_role_keys:
            - "cdata${family_id}-${job_numeric_id}"
            - "pdata${family_id}-${job_numeric_id}"
      - for_each:
          list: "${expected_role_keys}"
          do:
            - op: find_in_array
              array: "${job_definition.datasets}"
              where:
                role_key: "${item}"
              store_as: dataset_def
            - op: api_rows_com__jit_plugin.getRowsValues
              args:
                sheet_id: "${dataset_def.sheet_id}"
                table_id: "${dataset_def.table_id}"
                range: "${dataset_def.range}"
              expect_has_items: true
              store_as: "datasets_by_role.${item}"
      - assert_length:
          object: datasets_by_role
          equals: 2
      - continue: execute_lanes

  - name: execute_lanes
    steps:
      - load: pipeline_spec
      - for_each:
          list: "${job_definition.run_order}"
          do:
            - set: { lane_key: "${item}" }
            - op: get_lane_spec
              from: pipeline_spec
              key: "${lane_key}"
              store_as: lane_spec
            - op: items_clearroundtravel_com__jit_plugin.items_get
              args: { path: "blog/cp-2/${lane_spec.template_ref}.txt" }
              expect_status: 200
              store_as: template
            - op: execute_lane
              args:
                lane_spec: "${lane_spec}"
                template: "${template}"
                inputs: "${required_inputs}"
                datasets_by_role: "${datasets_by_role}"
              store_output: "${lane_spec.writes}"
      - continue: final_validation

  - name: final_validation
    steps:
      - op: validate_json_schema
        schema: final-schema.json
        data: final_output
        required_fields: [collection_body, places_body, summary_paragraph]
      - continue: commit

  - name: commit
    steps:
      - op: build_commit_request
        spec: commit-spec.json
        inputs:
          final_out_bin: final_output
          run_log_json: lane_execution_log
        store_as: commit_request
      - op: items_clearroundtravel_com__jit_plugin.docs_commit_bulk
        args: "${commit_request}"
        expect:
          ok: true
          commit.sha_regex: "^[a-f0-9]{40}$"
        store_as: commit_response
      - op: items_clearroundtravel_com__jit_plugin.docs_get
        args: { path: "${commit_response.committed_paths[0]}" }
        expect_status: 200
      - continue: respond

  - name: respond
    steps:
      - output_json:
          job_id: "${job_definition.job_id}"
          mode: live
          executed_run_order: "${job_definition.run_order}"
          committed_paths: "${commit_response.committed_paths}"
          commit_sha: "${commit_response.commit.sha}"
          runner_marker: job-cp2-live
