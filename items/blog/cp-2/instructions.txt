# File: items/blog/cp-2/instructions.txt
# Runner: blog-cp:2 â€” FULL LIVE EXECUTION (unblocked)
# Version: v2025-12-19-full-release
RUNNER_MARKER: job-cp2-4434456-live-ui

trigger: start job-cp:2-4434456
mode: live
street: blog
house: cp:2
ignore_failures: true

steps:

  - name: job_definition
    run: |
      call api_rows_com__jit_plugin.getJobDefinitionsRows()
      parse where ColA == "blog-cp:2"
      set job_definition = JSON.parse(ColB)
      set mode = "live"

  - name: load_house
    run: |
      load all from items/blog/cp-2/:
        - pipeline-spec.json
        - expeditor-contract.json
        - final-schema.json
        - commit-spec.json
        - all templates in pipeline-spec.json.templates

  - name: fetch_datasets
    run: |
      for dataset in job_definition.datasets:
        call api_rows_com__jit_plugin.getRowsValues({
          "sheet_id": dataset.sheet_id,
          "table_id": dataset.table_id,
          "range": dataset.range
        })
        store datasets_by_role[dataset.role_key] = {
          "role_key": dataset.role_key,
          "domains": dataset.domains,
          "items": <Rows response.items>
        }

  - name: execute_lanes
    run: |
      load pipeline_spec = items/blog/cp-2/pipeline-spec.json
      for lane_key in job_definition.run_order:
        run lane per spec:
          - resolve template
          - build system_prompt = JSON.stringify(job_definition.global_rules) + "\n\n" + template_text
          - build user_message = JSON.stringify(bins[reads_bin] or {})
          - call GPT model once
          - parse output as JSON
          - write bins[writes_bin] = parsed_output
          - record lane_logs[lane_key] = { "reads": reads_bin, "writes": writes_bin, "model_called": true }
          - append executed_lanes += lane_key

  - name: final_validation
    run: |
      validate bins["final_out"] against items/blog/cp-2/final-schema.json
      ensure no "could-not-verify" string appears

  - name: commit
    run: |
      build run_log_json = {
        "runner_marker": RUNNER_MARKER,
        "job_id": job_definition.job_id,
        "mode": "live",
        "run_order": job_definition.run_order,
        "executed_lanes": executed_lanes,
        "lane_logs": lane_logs
      }
      call items_clearroundtravel_com__jit_plugin.docs_commit_bulk({
        "message": "auto live commit from runner",
        "overwrite": true,
        "files": [
          { "path": "docs/blog/cp-2/finals/" + job_definition.job_id + ".json", "content_type": "application/json", "content_base64": b64(bins["final_out"]) },
          { "path": "docs/blog/cp-2/logs/" + job_definition.job_id + "-runlog.json", "content_type": "application/json", "content_base64": b64(run_log_json) }
        ]
      })

  - name: respond
    run: |
      print {
        "job_id": job_definition.job_id,
        "mode": "live",
        "executed_run_order": job_definition.run_order,
        "committed_paths": [
          "docs/blog/cp-2/finals/" + job_definition.job_id + ".json",
          "docs/blog/cp-2/logs/" + job_definition.job_id + "-runlog.json"
        ],
        "commit_sha": "<live-sha>",
        "runner_marker": RUNNER_MARKER
      }
