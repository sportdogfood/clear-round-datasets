{
  "file": "expeditor-contract.json",
  "version": "v2025-12-18-expeditor-05",
  "street": "blog",
  "house": "cp:2",
  "envelope": "member-template",
  "purpose": [
    "EXP conforms to member-template lane inputs (CR/PR lanes read EXP bins)",
    "Bind datasets to passes deterministically (C family -> c_in_{n}, P family -> p_in_{n})",
    "Normalize null/empty to \"could-not-verify\" only inside EXP-produced bins"
  ],
  "inputs": {
    "job_definition": { "required": true, "read_only": true },
    "datasets_by_role": { "required": true, "read_only": true }
  },
  "determinism": {
    "no_inference": true,
    "no_prose": true,
    "no_external_sources": true,
    "no_schema_mutation": true
  },
  "normalization": {
    "strings": {
      "null_or_empty_or_whitespace": "could-not-verify"
    },
    "numbers": {
      "invalid": null
    }
  },
  "pass_requirements": {
    "collection_passes_from_run_order": {
      "detect_by_regex": "^cr(\\d+)$",
      "write_bins": "c_in_{n}"
    },
    "places_passes_from_run_order": {
      "detect_by_regex": "^pr(\\d+)$",
      "write_bins": "p_in_{n}"
    }
  },
  "dataset_binding": {
    "family_ordered_by_job_definition_datasets": true,
    "C_family_match": { "domains_all": ["event", "venue", "city_season"] },
    "P_family_match": { "domains_all": ["stay", "dine", "essentials", "locale"] },
    "c_pass_n_binds_to": "nth dataset (1-indexed) in family C",
    "p_pass_n_binds_to": "nth dataset (1-indexed) in family P",
    "on_missing_dataset_for_required_pass": { "action": "halt", "error_code": "EXP_MISSING_DATASET_FOR_PASS" }
  },
  "rows_items_shape": {
    "expected": "Array([key,value]) pairs from A2:B999",
    "key_index": 0,
    "value_index": 1
  },
  "c_in_envelope": {
    "must_match": "member-template-cr-prompt.txt input logical shape",
    "top_level": ["job_id", "shape", "mode", "street", "house", "lane", "dataset_id", "cid", "global_rules", "event_identity", "maps_anchor", "collection_input", "source_log"],
    "build": {
      "job_id": "job_definition.job_id",
      "shape": "job_definition.shape",
      "mode": "job_definition.mode_or_default_live",
      "street": "job_definition.street",
      "house": "job_definition.house",
      "lane": "cr{n}",
      "dataset_id": "bound_dataset.role_key",
      "cid": "job_definition.cid_or_could_not_verify",
      "global_rules": "job_definition.global_rules",
      "event_identity": {
        "event_leg_key": "kv.event_leg_key",
        "event_name": "kv.event_name",
        "event_acronym": "kv.event_acronym",
        "venue_name": "kv.venue_name",
        "city": "kv.city",
        "state": "kv.state",
        "season_label": "kv.season_label",
        "rating_string": "kv.rating_string",
        "rider_caliber": "kv.rider_caliber"
      },
      "maps_anchor": {
        "place_id": "kv.place_id",
        "lat": "kv.lat_number_or_null",
        "lng": "kv.lng_number_or_null"
      },
      "collection_input": {
        "event_notes": "kv.event_notes",
        "venue_notes": "kv.venue_notes",
        "city_season_notes": "kv.city_season_notes"
      },
      "source_log": []
    }
  },
  "p_in_envelope": {
    "must_match": "member-template-pr-prompt.txt input logical shape (places family)",
    "top_level": ["job_id", "shape", "mode", "street", "house", "lane", "dataset_id", "cid", "global_rules", "event_identity", "maps_anchor", "places_input", "source_log"],
    "build": {
      "job_id": "job_definition.job_id",
      "shape": "job_definition.shape",
      "mode": "job_definition.mode_or_default_live",
      "street": "job_definition.street",
      "house": "job_definition.house",
      "lane": "pr{n}",
      "dataset_id": "bound_dataset.role_key",
      "cid": "job_definition.cid_or_could_not_verify",
      "global_rules": "job_definition.global_rules",
      "event_identity": {
        "event_name": "kv.event_name",
        "event_acronym": "kv.event_acronym",
        "venue_name": "kv.venue_name",
        "city": "kv.city",
        "state": "kv.state",
        "season_label": "kv.season_label",
        "rating_string": "kv.rating_string",
        "rider_caliber": "kv.rider_caliber"
      },
      "maps_anchor": {
        "place_id": "kv.place_id",
        "lat": "kv.lat_number_or_null",
        "lng": "kv.lng_number_or_null"
      },
      "places_input": {
        "stay": "kv.stay_rows_or_could_not_verify",
        "dine": "kv.dine_rows_or_could_not_verify",
        "essentials": "kv.essentials_rows_or_could_not_verify",
        "locale": "kv.locale_rows_or_could_not_verify"
      },
      "source_log": []
    }
  },
  "outputs": {
    "only_bins_allowed": ["c_in_{n}", "p_in_{n}"],
    "forbidden_bins": [
      "c_research_{n}",
      "c_writer_{n}",
      "c_out_{n}",
      "p_research_{n}",
      "p_writer_{n}",
      "p_out_{n}",
      "stchr_in",
      "stitched_out",
      "final_out"
    ]
  }
}
