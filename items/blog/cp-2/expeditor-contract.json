{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://clearroundtravel.com/specs/blog/cp-2/expeditor-contract.json",
  "file": "expeditor-contract.json",
  "version": "v2025-12-20-exp-08",
  "street": "blog",
  "house": "cp:2",

  "live_only": {
    "required": true,
    "mode_literal": "live",
    "halt_if_job_definition_mode_not_live": true,
    "on_fail": {
      "action": "halt",
      "error_code": "EXP_JOB_MODE_NOT_LIVE"
    }
  },

  "purpose": [
    "Identify the datasets that feed the 'collection' and 'places' lanes.",
    "Map each dataset directly to the matching lane input (no intermediate bins).",
    "Perform no computation, inference, or mutation."
  ],

  "inputs": {
    "job_definition": {
      "required": true,
      "read_only": true,
      "required_fields": [
        "job_id",
        "mode",
        "street",
        "house",
        "datasets",
        "run_order"
      ]
    },
    "datasets_by_role": {
      "required": true,
      "read_only": true,
      "shape": {
        "type": "object",
        "additionalProperties": {
          "type": "object",
          "required": ["role_key", "items"],
          "properties": {
            "role_key": { "type": "string" },
            "items": { "type": "array" }
          }
        }
      }
    }
  },

  "dataset_binding": {
    "collection_prefix": "cdata",
    "places_prefix": "pdata",
    "binding_rule": "Select exactly one dataset whose role_key starts with each prefix. Pass these unmodified into the collection and places lanes.",
    "fail_if_multiple": true,
    "fail_if_missing": true
  },

  "behavior": {
    "mutation_allowed": false,
    "inference_allowed": false,
    "external_calls_allowed": false,
    "emit_only_direct_dataset_payloads": true,
    "no_virtual_bins": true
  },

  "validation": {
    "on_missing_dataset": {
      "action": "halt",
      "error_code": "EXP_DATASET_MISSING"
    },
    "on_multiple_matching_prefixes": {
      "action": "halt",
      "error_code": "EXP_DATASET_AMBIGUOUS"
    },
    "on_mode_not_live": {
      "action": "halt",
      "error_code": "EXP_JOB_MODE_NOT_LIVE"
    }
  },

  "handoff": {
    "collection_input": {
      "source": "datasets_by_role[role_key starting with cdata].items",
      "description": "All collection dataset rows (event, venue, city_season)."
    },
    "places_input": {
      "source": "datasets_by_role[role_key starting with pdata].items",
      "description": "All places dataset rows (stay, dine, essentials, locale)."
    },
    "note": "The expeditor simply relays both datasets for use in their respective lanes."
  }
}
