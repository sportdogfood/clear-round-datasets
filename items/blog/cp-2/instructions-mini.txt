# File: items/blog/cp-2/instructions-mini.txt
# Runner: blog-cp:2 â€” MINI (toaster gatekeeper, no brains)
# Version: v2025-12-18-min-02
# Updated: 2025-12-18T00:00:00-05:00

============================================================
PURPOSE (HARD)
============================================================

This MINI runner is a deterministic gatekeeper + executor.

It MUST:
- validate trigger and job-definition
- load required house assets
- fetch declared datasets
- execute lanes sequentially per job_definition.run_order (NO brains / NO delegation)
- commit final artifacts exactly as produced
- return ONE final success or failure message

It MUST NOT:
- infer intent
- alter schemas
- reshape lane outputs
- emit partial progress chatter

============================================================
1) TRIGGER
============================================================

Accept ONLY:
- start blog-cp:2

On any other input:
- DO NOTHING.

Constants:
- street_token = "blog"
- house_token  = "cp:2"
- house_slug   = "cp-2"   (filesystem: replace ':' -> '-')

============================================================
2) LOAD job_definition (Rows)
============================================================

Call Rows:
GET /spreadsheets/GqOwXTcrQ9u14dbdcTxWa/tables/a2300cab-6557-4c6a-8e48-129b169bcc68/values/A2:B999

Interpret:
- Col A = trigger key
- Col B = job_definition JSON string

Select row where Col A == "blog-cp:2"
Parse Col B as job_definition.

Hard validations:
- job_definition.street == "blog"
- job_definition.house  == "cp:2"
- job_definition.job_id exists (string)
- job_definition.run_order exists (non-empty array)
- job_definition.datasets exists (non-empty array)
- job_definition.global_rules exists (object)
- job_definition.paths.docs_finals_root starts with "docs/" and ends with "/"
- job_definition.paths.docs_logs_root   starts with "docs/" and ends with "/"
- job_definition.output_format exists (string)

Derive:
- mode = job_definition.mode if present else "live"

If any fail:
- STOP with one error: "job_definition validation"

============================================================
3) LOAD HOUSE ASSETS (Git)
============================================================

House root (fixed):
- items/blog/cp-2/

Files required:
- pipeline-spec.json
- expeditor-contract.json
- final-schema.json
- commit-spec.json

Lane templates required (must exist if referenced by pipeline-spec.json):
- member-template-cr-prompt.txt
- member-template-cw-prompt.txt
- member-template-crwtr-prompt.txt
- member-template-pr-prompt.txt
- member-template-pw-prompt.txt
- member-template-prwtr-prompt.txt
- member-template-stchr-prompt.txt
- member-template-srwrtr-prompt.txt

If any required file missing:
- STOP with one error: "house configuration incomplete"

============================================================
4) FETCH DATASETS (Rows)
============================================================

For EACH entry in job_definition.datasets (in order given):
Required fields:
- role_key, sheet_id, table_id, range, domains

Call Rows:
GET /spreadsheets/{sheet_id}/tables/{table_id}/values/{range}

Store:
datasets_by_role[role_key] = {
  "role_key": role_key,
  "domains": <domains from job_definition>,
  "items": <rows returned>
}

Rules:
- no reshape
- no filtering
- no enrichment

If any dataset fetch fails:
- STOP with one error naming role_key

============================================================
5) EXECUTE RUN ORDER (THE TOASTER)
============================================================

Initialize:
- bins = {}          // ephemeral, in-run only
- lane_logs = {}     // keyed by lane key, minimal

Load pipeline_spec from pipeline-spec.json.
All lane keys MUST exist in pipeline_spec.lane_registry.

For each lane_key in job_definition.run_order:
- Lookup lane_spec = pipeline_spec.lane_registry[lane_key]
- If missing: STOP "unknown lane key"

Execute by lane_spec.type:

A) type == "data_sorter" (exp)
- Input: { "job_definition": job_definition, "datasets_by_role": datasets_by_role }
- Output: one JSON object with keys for every produced input bin (ex: c_in_1, p_in_1, etc)
- Write each produced bin into bins[bin_name] = <bin_object>
- Hard-stop if any required input bin for later lanes is not produced

B) type in {"researcher","writer","rewriter","stitcher"}
- If lane_spec.reads_dynamic exists:
  - Build target_bin = lane_spec.reads_dynamic.target_bin
  - Collect all existing bins where name starts with any prefix in lane_spec.reads_dynamic.include_prefixes
  - Hard-stop if zero bins collected
  - Create bins[target_bin] as exactly ONE JSON object:
    {
      "job_id": job_definition.job_id,
      "street": job_definition.street,
      "house": job_definition.house,
      "lane": lane_key,
      "global_rules": job_definition.global_rules,
      "inputs": [
        { "bin": "<bin_name>", "data": <bins[bin_name]> }
      ]
    }
- Require reads_bin exists:
  - reads_bin = lane_spec.reads_bin
  - if bins[reads_bin] missing: STOP "missing reads_bin"
- Build lane system prompt = JSON(job_definition.global_rules) + "\n\n" + template_text
- Call the model with:
  - system = lane system prompt
  - user   = JSON(bins[reads_bin])   (exactly one object)
- Parse returned content as JSON object
- Write to bins[writes_bin] (must not already exist)
- Record minimal lane_logs[lane_key] = { "reads": reads_bin, "writes": writes_bin }

C) type == "commit"
- Require bins["final_out"] exists
- Commit artifacts exactly per commit-spec.json (no mutation of final JSON)
- STOP on commit failure

============================================================
6) FINAL VALIDATION + USER RESPONSE
============================================================

Validate bins["final_out"] against final-schema.json (hard stop on mismatch).

On success: send ONE message containing:
- job_id
- mode
- executed run_order
- committed JSON path
- committed HTML path (if output_format requires)
- committed LOG path
- commit SHA (if available)

On failure: ONE concise error naming the failing phase only:
- job_definition
- house load
- dataset fetch
- lane execution
- final validation
- commit

============================================================
END OF FILE
============================================================
