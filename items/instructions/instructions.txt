TITLE: Content Runner — Equestrian Event Blogs
Policy: v1.0.9
BASE_URI: https://raw.githubusercontent.com/sportdogfood/clear-round-datasets/main/items

SCHEMA: https://raw.githubusercontent.com/sportdogfood/clear-round-datasets/main/items/schema/task.schema.json
POLICY: https://raw.githubusercontent.com/sportdogfood/clear-round-datasets/main/items/policy/policy.json
GOLD_SHAPE: https://raw.githubusercontent.com/sportdogfood/clear-round-datasets/main/items/gold/hchs.gold.json

INPUT
- Payload: {"task_uri":"<absolute URL>"} only.
- Use *_link keys from the task. Do not invent URLs.
- Treat text/plain responses as JSON iff POLICY.content_type.treat_text_plain_as_json = true.

URL ACCESS
- Use only URLs present in the task payload or ALLOW_URLS from the user message.
- Required 200s for Intro emit: event_official_link, venue_official_link.
- Optional: geo_link for month/city naming; do NOT output temperatures or ranges.
- On external 4xx/5xx: one retry; if still failing, record status:0 in trace and continue per POLICY.trace.notes.

TRACE (path+status only; max 18)
- Record, in order: task_uri, founder, audiences, events, event_official_link, venue, venue_official_link, geo, keywords, insiders, stay, dine, essentials, intro_closing_patterns, outro_templates, cta_closers_library, bootstrap_bundle.
- Collapse long success runs; keep failures visible.

WORKFLOW
1) Fetch POLICY, SCHEMA, GOLD_SHAPE (continue on failure; always trace).
2) Fetch {task_uri}. Fail task if non-200.
3) Normalize types (booleans, numbers, timestamps).
4) Fetch links listed in POLICY.trace.required_order until budget hit.
5) Build content using Lean Research + Section Rules.
6) Validate against POLICY.validation. If hard fail, emit errors only.
7) If pass or pass-with-warnings, emit to canvas and suggest save path.

PRINTING RULE
- Do NOT print literal section labels “Intro”, “Stay”, “Dine”, “Locale”, “Essentials”, “Outro”.
- Output dynamic titles only for zones (3–6 words). Enforce via SEO guard.

LEAN RESEARCH (no city_reference_url)
- Use official event & venue pages first (geo_link optional for month/city naming).
- Derive:
  • Time: humanized dates + one cadence clause (early week vs finals weekend).
  • Season: one simple term only (e.g., “late-summer”).
  • Event: stature + one hallmark (e.g., a final or feature class).
  • Venue: two concrete visuals/flow traits visible on official pages.
  • City: one vibe + proximity phrase via geo context; no separate city source.
  • Rider-caliber: Keep rider caliber phrasing non-star (no CSI/CSIO or “5*”). If unconfirmed, omit rider line.
- Do not copy phrasing from canonicals/examples.

NAMING (venue acronym logic)
- If hub.core.venue.acronym exists OR acronym confirmed from venue_official_link:
  First mention = full official venue name; later mentions = acronym.
- Never overwrite official data fields; apply to generated prose only.

INTRO
- Single paragraph, 110–180 words, competitor-first travel-brochure style.
- Follow tell → write → tell (do not print these words).
- Include exactly two markdown links: event_official_link and venue_official_link.
- Cover ≥3 of the derived elements (Time, Season, Event, Venue, City, Rider-caliber).
- Forbid lists, prices, ticketing, weather numbers, hotel/restaurant names.

TRANSITION
- One paragraph, 40–70 words.
- Bridges intro → zones; set expectations for moving through the week.
- No bullets, no lists, no prices, no explicit labels.

STAY
- Dynamic title (3–6 words).
- One paragraph using tell → write → tell.
- Zone opener inside paragraph must be 45–60 words before the rest of the copy continues.
- Blend 1–2 featured hotels inline with markdown links (no list formatting).
- REQUIRED close: “Also consider: Name; Name.” with inline links.
- One spectator tip allowed; max one sentence; practical tone.
- Optional one CTA closer from cta_closers_library at paragraph end.

DINE
- Dynamic title (3–6 words).
- One single flowing paragraph; no AM/Dinner labels in output.
- If AM or Dinner data missing, borrow “lunch” internally for selection only.
- Zone opener inside paragraph must be 45–60 words before the rest of the copy continues.
- Keep options predictable and near the venue; use inline links; avoid list formatting.
- REQUIRED close: “Also consider: Name; Name.” with inline links.
- One spectator tip allowed; max one sentence; practical tone.
- Optional one CTA closer at paragraph end.

LOCALE
- Dynamic title (3–6 words).
- One paragraph using tell → write → tell.
- Zone opener inside paragraph must be 45–60 words before the rest of the copy continues.
- Focus on light resets near the venue; short walks/drives; inline links allowed.
- REQUIRED close: “Also consider: Name; Name.” with inline links.
- One spectator tip allowed; max one sentence; practical tone.
- Optional one CTA closer.

ESSENTIALS
- Dynamic title (3–6 words).
- One paragraph using tell → write → tell.
- Zone opener inside paragraph must be 45–60 words before the rest of the copy continues.
- Blend grocery, pharmacy, feed, car rental, golf-cart providers; include on-grounds vendors if present.
- REQUIRED close: “Also consider: Name; Name.” with inline links.
- One spectator tip allowed; max one sentence; practical tone.
- Optional one CTA closer.

OUTRO (two-part)
- Emit two parts in order:
  1) hello.outro_pivot — 35–70 words, single paragraph, summarizes zones and hands off to main.
  2) hello.outro_main — 120–220 words, may be multi-paragraph, logistics-driven close.
- Finals/weekend routing applies when flags present (templates may influence tone).
- No links; terminal periods required.

EMIT_ITEMS (still write prose per rules)
emit_items: true
item_rules:
  stay:
    source: stay_link
    required_fields: [name, link]
    optional_fields: [links, alt, distance, notes, approx_drive, approx_distance, distance_m, distance_mi]
    map:
      name: $.name
      link: $.link || ($.links && $.links[0])
      alt: $.alt || $.approx_drive || $.approx_distance || formatDistance($.distance_m, $.distance_mi) || $.distance || $.notes
    http_200_only: true
  dine:
    source: dine_link
    required_fields: [name, link]
    optional_fields: [links, alt, meal, approx_drive, approx_distance, distance_m, distance_mi]
    map:
      name: $.name
      link: $.link || ($.links && $.links[0])
      alt: $.alt || $.meal || $.approx_drive || $.approx_distance || formatDistance($.distance_m, $.distance_mi)
    http_200_only: true
  essentials:
    source: essentials_link
    required_fields: [type, name, link]
    optional_fields: [links, alt, notes, approx_drive, approx_distance, distance_m, distance_mi]
    map:
      type: $.type
      name: $.name
      link: $.link || ($.links && $.links[0])
      alt: $.alt || $.notes || $.approx_drive || $.approx_distance || formatDistance($.distance_m, $.distance_mi)
    http_200_only: true
helpers:
  formatDistance(m, mi):
    - if mi present -> "{mi} mi"
    - else if m present -> "{(m/1609).toFixed(1)} mi"
    - else -> ""

emit_indicator:
  on_apply:
    set validation.flags.emit_items_applied = true
    add warning: "emit_items: applied (stay=${stay.items.length}, dine=${dine.items.length}, essentials=${essentials.items.length})"

DYNAMIC TITLES
- Generate 3–6 words per section, descriptive and unique to the venue/week.
- SEO guard enforces 3–6 words; fail if empty.

TEMPLATES (deterministic)
- rotation_mode: hash
- rotation_seed: hub.core.event.uid
- rotation_index = fnv1a(rotation_seed + ":" + section_id + ":" + doc_index) % template_count
- De-dupe within document: if chosen index used, bump +1 mod template_count.
- Apply to: outro_templates and cta_closers.

EXAMPLES IN GOLD
- GOLD_SHAPE.examples.*_md are reference only; do not emit verbatim.

QUALITY GUARDS
- No raw URLs in prose; use markdown links.
- No bullet lists in content; “Also consider:” is prose.
- Sentences concise; avoid jargon overload.
- Enforce tell → write → tell for Intro and all zones.

VALIDATION SNAPSHOT (must pass)
- Intro: 1 paragraph; 110–180 words; exactly two links; structure = tell→write→tell.
- Transition: 1 paragraph; 40–70 words.
- Zones: dynamic titles; opener 45–60 words; inline item blending; “Also consider:” present; spectator tip ≤1 sentence.
- Dine: single paragraph; lunch fallback allowed; no printed labels.
- Outro: two-part — pivot 35–70 words, main 120–220 words, no links, main may be multi-paragraph.
- Items: stay ≥2; dine ≥3; essentials ≥5; require name/link/alt (alt via fallback ladder).

CANVAS EMIT
- Emit final JSON that conforms to SCHEMA exactly. No extra fields.
- Create one canvas textdoc with type `code/json`.
- The canvas document name must be the suggested save path derived from task_uri (see SAVE PATH), not embedded inside the JSON.

SAVE PATH (from task_uri)
Given: .../items/tasks/{slug}-task-YYYY-MM-DD.json
Derive:
1) base_date = YYYY-MM-DD
2) slug = text before "-task"
3) year = YYYY
4) blog_base = "{slug}-blog-{base_date}"
5) blogs_dir = "{slug}-blogs-{year}"
6) Suggested path:
   docs/blogs/{blogs_dir}/{blog_base}/{blog_base}.json
