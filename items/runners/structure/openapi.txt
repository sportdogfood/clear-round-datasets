openapi: 3.1.0
info:
  title: CRT Proxy
  version: "1.1.0"

servers:
  - url: https://items.clearroundtravel.com

paths:
  /docs/{path}:
    get:
      operationId: crt_get
      summary: Read a docs file via proxy
      parameters:
        - in: path
          name: path
          required: true
          description: |
            Path under docs/, e.g. _healthz.json or blogs/_ping/index.html
          schema:
            type: string
      responses:
        "200":
          description: OK
          content:
            "*/*":
              schema:
                type: string
        "4XX":
          description: Client error
        "5XX":
          description: Server error

  /docs/commit-bulk:
    post:
      operationId: crt_bulk_commit
      summary: Bulk commit multiple files under docs/
      description: >-
        Accepts compiled files (HTML/XML/JSON) and writes them atomically under
        docs/. The runner compiles from a 1-point trigger. This endpoint does
        not accept triggers; examples include a trigger payload for reference.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/FilesCommitRequest'
            examples:
              filesMode:
                summary: Commit explicit files
                value:
                  message: "chore: add year redirects"
                  overwrite: true
                  files:
                    - path: "docs/blogs/2025/index.html"
                      content_type: "text/html"
                      content_base64: "PCFkb2N0eXBlIGh0bWw+..."
                    - path: "docs/blogs/2026/index.html"
                      content_type: "text/html"
                      content_base64: "PCFkb2N0eXBlIGh0bWw+..."
              triggerMode:
                summary: Informational example of a trigger payload (proxy ignores)
                value:
                  add_post: "https://raw.githubusercontent.com/sportdogfood/clear-round-datasets/main/docs/blogs/desc-blogs-2025/desc-blog-2025-10-02/desc-blog-2025-10-02.json"
                  canonical_base: "https://blog.clearroundtravel.com"
                  images_link: "https://raw.githubusercontent.com/sportdogfood/clear-round-datasets/main/items/images/desc-images.json"
              forbiddenBlogJson:
                summary: Forbidden attempt to write source blog JSON
                value:
                  message: "chore: test guard"
                  overwrite: true
                  files:
                    - path: "docs/blogs/desc-blogs-2025/desc-blog-2025-10-02/desc-blog-2025-10-02.json"
                      content_type: "application/json"
                      content_base64: "eyAiZm9yYmlkZGVuIjogdHJ1ZSB9"
      responses:
        "200":
          description: Commit result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CommitResponse'
        "400":
          description: Bad request (validation, fetch failure, etc.)
        "5XX":
          description: Server error
      x-write-guards:
        deny_patterns:
          - "**/*-blog-????-??-??.json"
        allow_patterns:
          - "**/*-publish-????-??-??.json"
          - "docs/blogs/index.html"
          - "docs/blogs/[0-9][0-9][0-9][0-9]/index.html"
          - "docs/blogs/**/index.html"
          - "docs/blogs/rss.xml"
          - "docs/sitemap.xml"
          - "docs/blogs/manifest.json"
        on_violation: halt
      x-validate:
        base64_must_decode: true
        reject_zero_byte: true
        on_failure_status: 400
        on_failure_body:
          reason: validation_failed
          include_details: true
        required_paths:
          - path: "docs/blogs/**/{slug}/{publish_slug}.json"
            content_type: "application/json"
            min_bytes: 100
          - path: "docs/blogs/**/{slug}/index.html"
            content_type: "text/html"
            min_bytes: 200
          - path: "docs/blogs/index.html"
            content_type: "text/html"
            min_bytes: 200
          - path: "docs/blogs/[0-9][0-9][0-9][0-9]/index.html"
            content_type: "text/html"
            min_bytes: 200
          - path: "docs/blogs/rss.xml"
            content_type: "application/xml"
            min_bytes: 80
          - path: "docs/sitemap.xml"
            content_type: "application/xml"
            min_bytes: 80
          - path: "docs/blogs/manifest.json"
            content_type: "application/json"
            min_bytes: 50
      x-notes:
        - Templates must read from publish JSON only; do not read `*-blog-*.json`.
        - If trigger.add_post is under docs/, treat it as read-only source.
      x-contract:
        runner_compiles: true

components:
  schemas:
    FileItem:
      type: object
      required: [path, content_base64]
      properties:
        path:
          type: string
          description: Must start with docs/
          pattern: "^docs/.+$"
        content_type:
          type: string
          description: text/html, application/xml, or application/json
        content_base64:
          type: string
          description: Base64 of file bytes

    FilesCommitRequest:
      type: object
      required: [files]
      properties:
        message:
          type: string
        overwrite:
          type: boolean
          description: Force-update the ref to the new commit
          default: true
        files:
          type: array
          minItems: 1
          items:
            $ref: '#/components/schemas/FileItem'

    # Preserved for reference; NOT accepted by /docs/commit-bulk.
    TriggerRequest:
      type: object
      description: >-
        Minimal trigger used by the runner to fetch inputs and compile outputs
        before calling /docs/commit-bulk.
      properties:
        add_post:
          type: string
          format: uri
          description: Raw GitHub URL to the post JSON (e.g., docs/blogs/{venue}-blogs-{year}/{slug}/{slug}.json)
        canonical_base:
          type: string
          format: uri
          description: Public site origin for canonical links (e.g., https://blog.clearroundtravel.com)
          default: "https://blog.clearroundtravel.com"
        images_link:
          type: string
          format: uri
          description: Optional JSON with image links; used primarily for card image
        allow_urls:
          type: array
          items:
            type: string
            format: uri
          description: Optional list of URLs the upstream runner may fetch (informational)
        trigger:
          type: object
          properties:
            add_post: { type: string, format: uri }
            canonical_base: { type: string, format: uri, default: "https://blog.clearroundtravel.com" }
            images_link: { type: string, format: uri }
            allow_urls:
              type: array
              items: { type: string, format: uri }

    CommitResponse:
      type: object
      properties:
        ok:
          type: boolean
        commit:
          type: object
          properties:
            sha: { type: string }
            url: { type: string, format: uri }
        committed_paths:
          type: array
          items: { type: string }
