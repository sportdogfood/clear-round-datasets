# items/runners/structure/openapi.txt
openapi: 3.1.0
info:
  title: CRT Proxy
  version: "1.1.1"
servers:
  - url: https://items.clearroundtravel.com

paths:
  /docs/{path}:
    get:
      operationId: crt_get
      summary: Read a docs file via proxy
      description: Fetches a file under docs/ from the upstream repository and returns its raw contents. The path is relative to docs/.
      parameters:
        - in: path
          name: path
          required: true
          description: Path under docs/, e.g. blogs/index.html or blogs/2025/index.html
          schema: { type: string }
      responses:
        "200":
          description: OK
          content:
            "*/*":
              schema: { type: string }
        "4XX": { description: Client error }
        "5XX": { description: Server error }

  /docs/commit-bulk:
    post:
      operationId: crt_bulk_commit
      summary: Bulk commit multiple docs/* files (single Git commit)
      description: Creates one commit containing multiple docs/* files. Supports classic files mode and builder hints via trigger. At least one of "files" or "trigger" must be present.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                message:
                  type: string
                  description: Commit message
                overwrite:
                  type: boolean
                  description: Force update the ref
                  default: true
                files:
                  type: array
                  minItems: 1
                  description: Classic mode â€” explicit files to write under docs/
                  items:
                    $ref: "#/components/schemas/FileItem"
                trigger:
                  $ref: "#/components/schemas/TriggerRequest"
              description: One object; include either "files" or "trigger".
            examples:
              filesMode:
                summary: Commit explicit files
                value:
                  message: "chore: add year index"
                  overwrite: true
                  files:
                    - path: "docs/blogs/2025/index.html"
                      content_type: "text/html"
                      content_base64: "PCEtLSBodG1sIC0tPg=="
                    - path: "docs/blogs/rss.xml"
                      content_type: "application/xml"
                      content_base64: "PD94bWwgdmVyc2lvbj0iMS4wIj8+"
              triggerMode:
                summary: Builder hints (one-point trigger)
                value:
                  message: "publish capc 2025-10-05"
                  overwrite: true
                  trigger:
                    add_post: "https://raw.githubusercontent.com/sportdogfood/clear-round-datasets/main/items/blogs/capc-cap-challenge-blog-2025-10-05.json"
                    canonical_base: "https://blog.clearroundtravel.com"
                    images_link: "https://raw.githubusercontent.com/sportdogfood/clear-round-datasets/main/items/images/capc-images.json"
      responses:
        "200":
          description: Commit result
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CommitResponse"
        "400": { description: Bad request (validation, fetch failure, etc.) }
        "5XX": { description: Server error }
      x-write-guards:
        deny_patterns:
          - "**/*-blog-????-??-??.json"
          - "**/*-blog.json"
        allow_patterns:
          - "**/*-publish-????-??-??.json"
          - "**/*-publish.json"
          - "docs/blogs/index.html"
          - "docs/blogs/[0-9][0-9][0-9][0-9]/index.html"
          - "docs/blogs/**/index.html"
          - "docs/blogs/rss.xml"
          - "docs/sitemap.xml"
          - "docs/blogs/manifest.json"
        on_violation: halt
      x-notes:
        - Templates must read from publish JSON only; do not read "*-blog*.json".
        - If trigger.add_post points under docs/, treat it strictly read-only.

components:
  schemas:
    FileItem:
      type: object
      required: [path, content_base64]
      properties:
        path:
          type: string
          description: Must start with docs/
          pattern: "^docs/.+$"
        content_type:
          type: string
          description: "text/html, application/xml, or application/json"
        content_base64:
          type: string
          description: Base64 of file bytes

    TriggerRequest:
      type: object
      description: Minimal hints used by an upstream runner to build outputs.
      properties:
        add_post:
          type: string
          format: uri
          description: Raw GitHub URL to source or trigger JSON
        canonical_base:
          type: string
          format: uri
          description: Site origin for canonical links
          default: "https://blog.clearroundtravel.com"
        images_link:
          type: string
          format: uri
          description: Optional JSON for image slots (hero/card/sections)
        allow_urls:
          type: array
          items:
            type: string
            format: uri
          description: Optional allow-list the runner may fetch (informational)

    CommitResponse:
      type: object
      properties:
        ok: { type: boolean }
        commit:
          type: object
          properties:
            sha: { type: string }
            url: { type: string, format: uri }
        committed_paths:
          type: array
          items: { type: string }
