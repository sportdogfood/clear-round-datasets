openapi: 3.1.0
info:
  title: CRT Proxy
  version: "1.1.0"
servers:
  - url: https://items.clearroundtravel.com

paths:
  /docs/{path}:
    get:
      operationId: crt_get
      summary: Read a docs file via proxy
      parameters:
        - in: path
          name: path
          required: true
          description: Path under docs/, e.g. _healthz.json or blogs/_ping/index.html
          schema:
            type: string
      responses:
        "200":
          description: OK
          content:
            "*/*":
              schema:
                type: string
        "4XX":
          description: Client error
        "5XX":
          description: Server error

  /docs/commit-bulk:
    post:
      operationId: crt_bulk_commit
      summary: Bulk commit multiple files under docs/, or build from a trigger
      description: >
        Accepts EITHER a list of files to commit (classic mode), OR a minimal
        trigger payload that points at a post JSON (builder mode). In builder
        mode, the server fetches the post JSON and generates:
        - post index.html (does NOT overwrite the post JSON)
        - blogs/manifest.json (upsert)
        - blogs/rss.xml
        - /sitemap.xml
      requestBody:
        required: true
        content:
          application/json:
            schema:
              oneOf:
                - $ref: '#/components/schemas/FilesCommitRequest'
                - $ref: '#/components/schemas/TriggerRequest'
            examples:
              filesMode:
                summary: Commit explicit files
                value:
                  message: "chore: add year redirects"
                  overwrite: true
                  files:
                    - path: "docs/blogs/2025/index.html"
                      content_type: "text/html"
                      content_base64: "PCFkb2N0eXBlIGh0bWw+..."
                    - path: "docs/blogs/2026/index.html"
                      content_type: "text/html"
                      content_base64: "PCFkb2N0eXBlIGh0bWw+..."
              triggerMode:
                summary: Build from a minimal trigger
                value:
                  add_post: "https://raw.githubusercontent.com/sportdogfood/clear-round-datasets/main/docs/blogs/desc-blogs-2025/desc-blog-2025-10-02/desc-blog-2025-10-02.json"
                  canonical_base: "https://blog.clearroundtravel.com"
                  images_link: "https://raw.githubusercontent.com/sportdogfood/clear-round-datasets/main/items/images/desc-images.json"
      responses:
        "200":
          description: Commit result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CommitResponse'
        "400":
          description: Bad request (validation, fetch failure, etc.)
        "5XX":
          description: Server error

components:
  schemas:
    FileItem:
      type: object
      required: [path, content_base64]
      properties:
        path:
          type: string
          description: Must start with docs/
          pattern: "^docs\\/.*$"
        content_type:
          type: string
          description: text/html, application/xml, or application/json
        content_base64:
          type: string
          description: Base64 of file bytes

    FilesCommitRequest:
      type: object
      required: [files]
      properties:
        message:
          type: string
        overwrite:
          type: boolean
          description: Force-update the ref to the new commit
          default: true
        files:
          type: array
          minItems: 1
          items:
            $ref: '#/components/schemas/FileItem'

    TriggerRequest:
      type: object
      description: >
        Minimal trigger to build blog artifacts. The server will fetch the post JSON
        (must be on raw.githubusercontent.com), derive paths, and generate output files.
      properties:
        # top-level (shorthand) fields
        add_post:
          type: string
          format: uri
          description: Raw GitHub URL to the post JSON (e.g., docs/blogs/{venue}-blogs-{year}/{slug}/{slug}.json)
        canonical_base:
          type: string
          format: uri
          description: Public site origin for canonical links (e.g., https://blog.clearroundtravel.com)
          default: "https://blog.clearroundtravel.com"
        images_link:
          type: string
          format: uri
          description: Optional JSON with image links; used primarily for card image
        allow_urls:
          type: array
          items:
            type: string
            format: uri
          description: Optional list of URLs the upstream runner may fetch (informational)

        # or nested under `trigger` for compatibility
        trigger:
          type: object
          properties:
            add_post:
              type: string
              format: uri
            canonical_base:
              type: string
              format: uri
              default: "https://blog.clearroundtravel.com"
            images_link:
              type: string
              format: uri
            allow_urls:
              type: array
              items:
                type: string
                format: uri
      oneOf:
        - required: [add_post]
        - required: [trigger]

    CommitResponse:
      type: object
      properties:
        ok:
          type: boolean
        commit:
          type: object
          properties:
            sha:
              type: string
            url:
              type: string
              format: uri
        committed_paths:
          type: array
          items:
            type: string
