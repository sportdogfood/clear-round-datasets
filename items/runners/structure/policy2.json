
{
  "version": "2025-10-12.2",
  "about": "Policy governs the Structure Runner that publishes blog artifacts under /docs/blogs. This is a STRICTLY additive update to preserve all existing behavior while enabling the one-point trigger, event-named slugs, seven-file contract, and preflight gates.",
  "defaults": {
    "canonical_base": "https://blog.clearroundtravel.com",
    "recent_count": 4,
    "rss_item_limit": 20,
    "placeholders": {
      "hero": "/assets/images/hero-placeholder.jpg",
      "stay": "/assets/images/stay-placeholder.jpg",
      "dine": "/assets/images/dine-placeholder.jpg",
      "place": "/assets/images/place-placeholder.jpg",
      "card": "/assets/images/card-placeholder.jpg"
    }
  },

  "write_allowlist": [
    "docs/blogs/**/index.html",
    "docs/blogs/[0-9][0-9][0-9][0-9]/index.html",
    "docs/blogs/index.html",
    "docs/blogs/rss.xml",
    "docs/sitemap.xml",
    "docs/blogs/manifest.json",

    // PUBLISH JSON (dated style, kept from original)
    "docs/blogs/**/**-publish-????-??-??.json",

    // PUBLISH JSON (event/named style, NEW — e.g., capc-cap-challenge-publish.json)
    "docs/blogs/**/**-publish.json"
  ],

  "write_denylist": [
    "**/*-blog-????-??-??.json",         // never write source authoring JSON
    "**/*-blog.json"                     // NEW: block non-dated authoring names too (e.g., event-named *-blog.json)
  ],

  "templates": {
    "post": "items/runners/structure/templates/blog.index.html.tmpl",
    "blogs_index": "items/runners/structure/templates/blogs.index.html.tmpl",
    "year_index": "items/runners/structure/templates/year.index.html.tmpl",
    "rss": "items/runners/structure/templates/rss.xml.tmpl",
    "sitemap": "items/runners/structure/templates/sitemap.xml.tmpl"
  },

  "manifest": {
    "schema": "items/runners/structure/manifest.schema.json",
    "upsert_key": "slug"
  },

  "fields": {
    "event": {
      "from": "event_link",
      "map": {
        "event_month": "month_name",
        "event_season": "season",
        "event_duration": "event_duration",
        "start_date": "start_date",
        "end_date": "end_date"
      }
    },
    "images": {
      "from": "images_link",
      "keys": [
        "hero_image_link",
        "hero_image_hidden",
        "stay_image_link",
        "stay_image_hidden",
        "dine_image_link",
        "dine_image_hidden",
        "essentials_image_link",
        "essentials_image_hidden",
        "locale_image_link",
        "locale_image_hidden",
        "card_image_link",
        "card_image_hidden",
        "image_alt_text"
      ]
    }
  },

  "rules": {
    "http_only": true,
    "https_only": true,
    "allowed_fetch_hosts": ["raw.githubusercontent.com"],
    "max_fetch_attempts": 2,
    "fetch_timeout_ms": 5000,
    "reject_non_http_links": true,

    "paragraphs_allow_markdown_inline_links": [
      "hello.intro",
      "hello.outro",
      "stay.paragraph",
      "dine.am",
      "dine.dinner",
      "locale.paragraph",
      "essentials.paragraph"
    ],
    "list_item_fields": ["name", "link", "alt"],

    "title_precedence": ["seo.section_title", "seo.open_graph_title", "title", "slug"],
    "seo_description_precedence": ["seo.meta_description", "seo.open_graph_description"],

    "neighbor_order": "date_desc",
    "idempotent_outputs": true,
    "deterministic_output": true,

    // NEW — One-point trigger contract
    "trigger_contract": {
      "required_minimum": [
        "canonical_base",
        "event_link"
      ],
      "optional": [
        "images_link",
        "section_link",
        "venue_link",
        "geo_link",
        "audiences_link"
      ],
      "paths_from_trigger_preferred": true,
      "paths_keys": [
        "blogs_publish_path",
        "blogs_publish_index_path",
        "blogs_index_path",
        "blogs_2025_index_path",
        "blogs_rss_path",
        "blogs_sitemap_path",
        "blogs_manifest_path"
      ],
      "fallback_paths_allowed": true
    },

    // NEW — Source/publish model & naming
    "publish_model": {
      "source_json_read_only": true,
      "publish_json_sibling": true,
      "naming_modes": ["dated_slug", "event_named_slug"],
      "publish_name_rules": [
        { "if_contains": "-blog-", "replace_with": "-publish-" },     // dated style
        { "if_suffix": "-blog.json", "replace_with": "-publish.json"} // event/named style
      ]
    },

    // NEW — Preflight (must pass before /docs/commit-bulk)
    "preflight": {
      "enabled": true,
      "exact_required_count": 7,
      "required": [
        { "path": "docs/blogs/**/**/index.html", "min_bytes": 200, "content_type": "text/html" },
        { "path": "docs/blogs/**/**-publish*.json", "min_bytes": 100, "content_type": "application/json" },
        { "path": "docs/blogs/index.html", "min_bytes": 200, "content_type": "text/html" },
        { "path": "docs/blogs/[0-9][0-9][0-9][0-9]/index.html", "min_bytes": 200, "content_type": "text/html" },
        { "path": "docs/blogs/rss.xml", "min_bytes": 80, "content_type": "application/xml" },
        { "path": "docs/sitemap.xml", "min_bytes": 80, "content_type": "application/xml" },
        { "path": "docs/blogs/manifest.json", "min_bytes": 50, "content_type": "application/json" }
      ],
      "require_base64": true,
      "validate_manifest_against_schema": true
    }
  },

  "indexes": {
    "build": ["/blogs/index.html", "/blogs/{year}/index.html"],
    "rss": "/blogs/rss.xml",
    "sitemap": "/sitemap.xml"
  },

  "security": {
    "forbid_write_source_blog_json": true,
    "allow_publish_json_only": true
  },

  "notes": [
    "Templates must read publish JSON only; never read *-blog-*.json.",
    "If trigger.add_post/content_link is under docs/, treat it as read-only.",
    "Write allowlist now supports BOTH dated publish JSON (…-publish-YYYY-MM-DD.json) and event/named publish JSON (…-publish.json).",
    "Preflight is mandatory: 7 outputs present, base64-decodable, and meeting minimum decoded byte thresholds before commit."
  ]
}
