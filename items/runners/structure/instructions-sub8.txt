# items/runners/structure/instruction.txt
# Purpose
# Publish blogs under /docs/blogs/ from a single task (“1-point trigger”).
# NEVER edit any *-blog-YYYY-MM-DD.json. Write a sibling *-publish-YYYY-MM-DD.json in the SAME folder.
# Templates MUST read the PUBLISH JSON only.

TRIGGER (message JSON)
{
  "add_post": "",            # raw.githubusercontent.com URL of the source post JSON
  "remove_post": "",         # optional
  "rebuild_all": true|false, # optional
  "canonical_base": "https://blog.clearroundtravel.com",
  "images_link": "",         # optional (desc-images.json)
  "section_link": "",        # optional SEO fallback JSON
  "allow_urls": [""]         # EVERY extra fetch target you plan to use
}

NETWORK RULES
- HTTPS only. Fetch ONLY: add_post, images_link, section_link, and URLs listed in allow_urls.
- Do NOT route these fetches through /docs/{path}.
- Retries: 2; timeout: 5s per request.

PATHS & SLUGS
- Root: docs/blogs/{venue}-blogs-{year}/{slug}/
- slug: {venue}-blog-{YYYY-MM-DD} (derive date from the source filename).
- publish_slug = slug with "-blog-" → "-publish-".
- Public links must start with /blogs/…

WRITE GUARDS (non-negotiable)
- FORBID writes to any *-blog-????-??-??.json → HALT (403).
- ONLY write the publish sibling JSON in the SAME folder as add_post.
- All writes must be within the WRITE ALLOWLIST below.

EVENT METADATA (from event_link; optional but preferred)
- Use as-is: event_month, event_season, event_duration (free text), start_date, end_date.
- Map event_duration → enum: single (1 day) | weekend (2–3 days) | multi-day (≥4 days).
- archive_year = YYYY(start_date) when present; else derive from slug date.
- Persist these on the PUBLISH JSON for templates/manifest.

IMAGES (desc-images.json)
- Keys: hero|stay|dine|essentials|locale _image_link/_image_hidden; card_image_link/_hidden; image_alt_text.
- If *_hidden==1 → skip slot; else use *_image_link when present.
- Card image for listings: manifest.image = card_image_link when provided.

INPUT SHAPES (post JSON)
- Use *.link fields (not *.url) e.g., stay.items[].link, dine.items[].link, essentials.items[].link.
- Paragraphs allow inline Markdown links ONLY for: hello.intro/outro, stay.paragraph, dine.am/dinner, locale.paragraph, essentials.paragraph.
- SEO: prefer post.seo; else fallback to section_link (if provided).
- External links must be http(s); internal links must be site-root absolute.

STEP ORDER (ENFORCED)
1) Fetch task JSON (the trigger).
2) Follow add_post → read source post JSON (READ-ONLY).
3) Optionally fetch images JSON; fetch event JSON when available and enrich.
4) Build publish JSON sibling next to the source JSON:
   - filename: {slug} with -blog-→-publish-
   - include post fields needed by templates
   - enrich with event fields + computed paths
5) Render ALL seven outputs (deterministic/idempotent):
   - docs/blogs/{venue}-blogs-{year}/{slug}/{publish_slug}.json
   - docs/blogs/{venue}-blogs-{year}/{slug}/index.html
   - docs/blogs/index.html
   - docs/blogs/{year}/index.html
   - docs/blogs/manifest.json   # upsert; json → publish file above
   - docs/blogs/rss.xml
   - docs/sitemap.xml
6) PRE-FLIGHT (runner-side; must pass BEFORE calling the proxy):
   - Base64: every file encodes valid, decodable bytes (UTF-8 for text).
   - Min bytes (decoded):
       publish JSON ≥ 100
       post index.html ≥ 200
       blogs/index.html ≥ 200
       year/index.html ≥ 200
       blogs/rss.xml ≥ 80
       sitemap.xml ≥ 80
       blogs/manifest.json ≥ 50
   - Required paths: exactly the seven above must be present.
   - Manifest validates against manifest.schema.json.
   - No file path matches *-blog-????-??-??.json.
7) Single commit:
   - POST /docs/commit-bulk with { message, overwrite:true, files:[…] }  (files-mode ONLY)
   - Do NOT send a trigger payload to the proxy.

MANIFEST RULES
- Top level is an array; upsert by slug.
- REQUIRED: slug, title, date, year, path, json, venue.
- RECOMMENDED: month_num, month_name, season, image, city, state, country, lat, lng, place_id, timezone, start_date, end_date, event_duration, audience_labels, tags, section_link, maps_link.
- Title precedence: blog.seo.section_title → blog.seo.open_graph_title → blog.title → slug.
- path: /blogs/{venue}-blogs-{year}/{slug}/
- json: /blogs/{venue}-blogs-{year}/{slug}/{publish_slug}.json   # MUST point to PUBLISH JSON

VALIDATION & SAFETY (runner-side)
- Internal links site-root absolute; external links http(s) only.
- Paragraph HTML is escaped; transform [label](https://…) → safe <a target="_blank" rel="noopener">; reject non-http(s).
- Per file: {path, content_type, base64, decoded_bytes >= min}.
- Idempotent: compute idempotency_key =
  normalized(add_post) | archive_year | event_month | event_season |
  mapped(event_duration) | start_date | end_date (if present).
- Per-file no-op: skip write when computed content hash unchanged.
- Outputs must be deterministic; no wall-clock values.

WRITE ALLOWLIST (only these may be written)
- docs/blogs/{venue}-blogs-{year}/{slug}/{publish_slug}.json
- docs/blogs/{venue}-blogs-{year}/{slug}/index.html
- docs/blogs/index.html
- docs/blogs/{year}/index.html
- docs/blogs/rss.xml
- docs/sitemap.xml
- docs/blogs/manifest.json

ERRORS → HALT (no partial writes)
- Any required fetch fails (task/post/event/images/section).
- Attempted write to any *-blog-*.json (403) or to a path outside the allowlist (403).
- Base64 decode fails or decoded bytes < required min.
- Required path missing.
- Manifest invalid against schema.
- Required template missing.

DEFAULTS (mirror policy.json)
- canonical_base: https://blog.clearroundtravel.com
- recent_count: 4
- rss_item_limit: 20
- Placeholders under /assets/images/: hero-placeholder.jpg, stay-placeholder.jpg, dine-placeholder.jpg, place-placeholder.jpg, card-placeholder.jpg
