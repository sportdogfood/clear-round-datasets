# items/runners/structure/brief.txt
Project brief — CRT Structure Runner & Heroku Proxy
Scope & goal
Last: 2025-10-12  Snapshot v: 2025-10-12-01

Use a Heroku Node proxy to read/write content in the sportdogfood/clear-round-datasets repo for blog generation. Trigger the Structure Runner with a single task URL (“one-point trigger”) to fetch inputs, render templates, and commit outputs back — without ever overwriting source authoring JSON.

Critical endpoints (MUST remain; do not modify/remove)
- POST /items/commit          — Airtable writes into items/* (JSON + text)
- POST /docs/commit           — Single JSON under docs/*
- POST /docs/commit-bulk      — Multiple files under docs/* (.html/.xml/.json)
- GET  /docs/{path}           — Read-through proxy (docs/*)
- GET  /items/*               — Read-through proxy (items/*) (HEAD/OPTIONS supported)
- (Compat) GET /items/alias/commit → routes to /items/commit (Airtable older scripts)

Non-negotiable env rules
- ALLOW_DIRS must ALWAYS include the full superset (never narrowed), exactly:
  events,months,seasons,days,years,weeks,labels,places,sources,organizers,cities,countries,hotels,states,weather,airports,venues,restaurants,agents,dine,essentials,legs,distances,insiders,keywords,audience,tone,ratings,links,spots,sections,bullets,services,stay,amenities,slots,cuisines,menus,locale,things,tags,blogs,platforms,geos,timezones,geometry,chains,knowledge,levels,types,core,brand,meta,hubs,zones,seo,outputs,tasks,instructions,schema,gold,policy,docs,runners,images,assets
- CORS allowlist must include Airtable: https://airtable.com, https://app.airtable.com, https://console.airtable.com
- UPSTREAM_BASE points to raw.githubusercontent.com; manifest mode enabled (no false “disabled”)

One-point trigger (task JSON) — minimal contract
- Required: canonical_base, event_link (raw GitHub URL)
- Optional: images_link, section_link, venue_link, geo_link, audiences_link
- Source content pointer (read-only): docs_path (docs/.../*.json) or content_link (raw URL)
- Paths (preferred; if omitted, runner derives): blogs_publish_path, blogs_publish_index_path, blogs_index_path, blogs_{YYYY}_index_path, blogs_rss_path, blogs_sitemap_path, blogs_manifest_path

Immutability & publish model
- Any *-blog*.json is READ-ONLY (never modified).
- Runner writes a sibling publish JSON only:
  • dated style: *-publish-YYYY-MM-DD.json
  • event-named: *-publish.json
- Templates & indexes must read from publish JSON only.

Slugs & dates
- If filename has -blog-YYYY-MM-DD → that defines {date}/{slug}.
- Else (event-named): slug = basename; date/year from event.start_date if present; year fallback from slug.

Event fields (from event_link)
- Read: event_month, event_season, event_duration, start_date, end_date
- Map duration → enum: single | weekend | multi-day
- Persist into publish JSON and manifest entry.

Images (from images_link)
- *_image_link / *_image_hidden + card_image_link/_hidden, image_alt_text
- *_hidden==1 → do not render that slot; card_image_link fills manifest.image if present.

Required outputs (exactly 7)
1) publish JSON                         → blogs_publish_path
2) post page (…/{slug}/index.html)      → blogs_publish_index_path
3) blogs index                          → blogs_index_path
4) year index                           → blogs_{year}_index_path
5) rss.xml                              → blogs_rss_path
6) sitemap.xml                          → blogs_sitemap_path
7) manifest.json (array upsert by slug) → blogs_manifest_path
Manifest required: slug, title, date, year, path, json, venue
Recommended when available: month_num, month_name, season, image, city/state/country, lat/lng/place_id, timezone, start_date, end_date, event_duration, audience_labels, tags, section_link, maps_link
IMPORTANT: manifest.json’s json field points to the publish JSON (never source).

Write-guards (hard stop before commit)
ALLOW ONLY:
- docs/blogs/**/index.html
- docs/blogs/[0-9][0-9][0-9][0-9]/index.html
- docs/blogs/index.html
- docs/blogs/rss.xml
- docs/sitemap.xml
- docs/blogs/manifest.json
- docs/blogs/**/**-publish-????-??-??.json   (dated)
- docs/blogs/**/**-publish.json              (event-named)
DENY ALWAYS:
- **/*-blog-????-??-??.json
- **/*-blog.json
Violation → HALT (no writes)

Preflight (Definition of Done — must pass before /docs/commit-bulk)
- Exactly 7 files present (no extras)
- Base64 decodes ok for each
- Min decoded bytes: publish≥100, post≥200, blogs≥200, year≥200, rss≥80, sitemap≥80, manifest≥50
- manifest.json validates against items/runners/structure/manifest.schema.json
- Log table: path | type | bytes | threshold | PASS/FAIL
Any FAIL → abort with table; no commit

Idempotence & ordering
- Deterministic outputs (no wall-clock)
- Neighbor links from date-desc snapshot of manifest (post-upsert model)
- Never mutate source *-blog*.json
- idempotency_key: normalized(source) | archive_year | event_month | event_season | mapped(event_duration) | start_date | end_date

Status
- Rendering logic lives in Git (runner + templates)
- Proxy remains a thin read/write pass-through (no rendering in server.js)
- This brief is the reference snapshot for naming, routes, safety rules, and 7-file DoD
