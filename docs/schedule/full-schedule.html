<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CRT Full Schedule</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <style>
:root {
      --bg: #020617;
      --bg-alt: #0b1120;
      --border: #374151;
      --border-soft: #4b5563;
      --accent: #2563eb;
      --pill-radius: 999px;
      --header-h: 52px;
      --nav-h: 72px;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html, body {
      margin: 0; padding: 0; height: 100%;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #020617 0, #020617 40%, #000 90%);
      color: #f9fafb;
    }
    body { display: flex; justify-content: center; align-items: stretch; }
    [hidden] { display: none !important; }

    .app {
      width: 100%;
      max-width: 480px;
      height: 100vh;
      max-height: 720px;
      margin: 8px;
      display: flex;
      flex-direction: column;
      background: var(--bg);
      border-radius: 24px;
      border: 1px solid rgba(15, 23, 42, 0.95);
      box-shadow: 0 24px 70px rgba(0, 0, 0, 0.95);
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
      overflow: hidden;
    }

    /* Header ----------------------------------------------------- */
    .app-header{
      height: var(--header-h);
      flex-shrink: 0;
      display: grid;
      grid-template-columns: 60px 1fr 60px;
      align-items: center;
      padding: 0 12px;
      border-bottom: 1px solid rgba(31, 41, 55, 0.95);
      background: #020617;
      backdrop-filter: blur(10px);
    }
    .header-back{ justify-self: start; }
    .header-title{ justify-self: center; text-align: center; }
    .header-spacer{ justify-self: end; width: 60px; height: 34px; }

    .header-back {
      min-width: 60px;
      height: 34px;
      padding: 0 16px;
      border-radius: var(--pill-radius);
      border: 1px solid var(--border-soft);
      background: #020617;
      color: #e5e7eb;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      box-shadow:
        0 0 0 1px rgba(15, 23, 42, 1),
        0 3px 10px rgba(0, 0, 0, 0.8);
      transition: transform 0.08s ease-out;
      user-select: none;
    }
    .header-back span { font-size: 16px; line-height: 1; }
    .header-back:active { transform: translateY(1px) scale(0.97); }

    .header-title {
      font-size: 16px;
      font-weight: 600;
      margin: 0;
      padding: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Main content ---------------------------------------------- */
    .app-main {
      flex: 1;
      overflow-y: auto;
      padding: 8px 12px 8px;
      background: radial-gradient(circle at top, #111827 0, #020617 52%);
    }

    .list-column { display: flex; flex-direction: column; gap: 8px; padding-bottom: 12px; }

    /* Start logo ------------------------------------------------- */
    .start-logo {
      display: flex; flex-direction: column; align-items: center;
      gap: 8px; margin: 10px 0 18px;
    }
    .start-logo-title { font-size: 18px; font-weight: 600; letter-spacing: 0.04em; text-align: center; }
    .start-logo-subtitle { font-size: 12px; color: #d1d5db; opacity: 0.9; }

    /* Rows ------------------------------------------------------- */
    .row {
      width: 100%;
      min-height: 46px;
      padding: 10px 16px;
      border-radius: var(--pill-radius);
      border: 1px solid var(--border-soft);
      background: #111827;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 14px;
      color: #e5e7eb;
      box-shadow: 0 1px 0 #020617;
    }
    .row-title { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding-right: 8px; }
    .row-tag {
      min-width: 28px; padding: 3px 10px; border-radius: var(--pill-radius);
      border: 1px solid var(--border-soft); background: #18181b; color: #e5e7eb;
      font-size: 11px; text-align: center; font-variant-numeric: tabular-nums;
      box-shadow: 0 0 0 1px #020617; white-space: nowrap;
    }
    .row-tag--count { min-width: 30px; }
    .row-tag--positive { border-color: #22c55e; background: #14532d; color: #f9fafb; }

    .row--tap { cursor: pointer; user-select: none; transition: transform 0.08s ease-out; }
    .row--tap:active { transform: translateY(1px) scale(0.995); }

    /* Search ----------------------------------------------------- */
    .state-search { margin: 4px 2px 10px; }
    .state-search-input {
      width: 100%;
      padding: 10px 16px;
      border-radius: var(--pill-radius);
      border: 1px solid var(--border-soft);
      background: #020617;
      color: #f9fafb;
      font-size: 14px;
      outline: none;
      box-shadow: 0 1px 0 #020617;
    }
    .state-search-input::placeholder { color: rgba(156, 163, 175, 0.95); }

    /* Bottom nav ------------------------------------------------ */
    .app-nav {
      height: var(--nav-h);
      flex-shrink: 0;
      border-top: 1px solid #27272f;
      background: #020617;
      box-shadow: 0 -14px 30px rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(12px);
      display: flex;
      align-items: flex-start;
      padding: 6px 6px 10px;
    }

    .nav-scroller { overflow-x: auto; -webkit-overflow-scrolling: touch; white-space: nowrap; width: 100%; }
    .nav-row { display: inline-flex; gap: 8px; padding: 0 4px; align-items: center; }

    .nav-btn {
      padding: 6px 14px;
      border-radius: var(--pill-radius);
      border: 1px solid #4b4f57;
      background: #18181b;
      color: #f9fafb;
      font-size: 12px;
      font-weight: 500;
      white-space: nowrap;
      cursor: pointer;
      user-select: none;
      box-shadow: 0 1px 0 #020617;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: transform 0.08s ease-out;
      text-decoration: none;
    }
    .nav-btn--primary {
      border-color: var(--accent);
      background: radial-gradient(circle at top, #1d4ed8, #1e3a8a 75%);
      color: #f9fafb;
      box-shadow: 0 0 0 1px #020617, 0 3px 10px rgba(15, 23, 42, 0.8);
    }
    .nav-btn:active { transform: translateY(1px) scale(0.98); }
    a.nav-btn { color: inherit; }

    .nav-agg {
      min-width: 22px; padding: 2px 8px; border-radius: 999px;
      border: 1px solid #4b5563; background: #111827; color: #e5e7eb;
      font-size: 11px; text-align: center; font-variant-numeric: tabular-nums;
      box-shadow: 0 0 0 1px #020617; white-space: nowrap; user-select: none;
    }
    .nav-agg--positive { border-color: #22c55e; background: #14532d; color: #f9fafb; }

    /* Peak bar --------------------------------------------------- */
    .peakbar {
      position: sticky;
      top: 0;
      z-index: 5;
      background: linear-gradient(to bottom, rgba(2,6,23,0.95), rgba(2,6,23,0.75));
      backdrop-filter: blur(10px);
      padding: 6px 0 8px;
      margin: -8px 0 6px;
    }

    /* Cards ------------------------------------------------------ */
    .card {
      border-radius: 18px;
      border: 1px solid rgba(75, 85, 99, 0.9);
      background: rgba(17, 24, 39, 0.95);
      overflow: hidden;
      box-shadow: 0 0 0 1px rgba(2, 6, 23, 0.9), 0 10px 24px rgba(0,0,0,0.45);
    }
    .card--tap { cursor: pointer; user-select: none; }
    .card--tap:active { transform: translateY(1px) scale(0.998); }

    .card-hdr{
      display: flex; align-items: center; justify-content: space-between; gap: 10px;
      padding: 10px 12px;
      border-bottom: 1px solid rgba(55,65,81,0.75);
      background: #111827;
    }
    .card-hdr--inverse{
      background: radial-gradient(circle at top, #1f2937, #020617 75%);
      border-bottom-color: rgba(37, 99, 235, 0.35);
    }
    .card-title{
      font-size: 14px; font-weight: 600; color: #f9fafb;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding-right: 8px;
    }
    .card-body{ padding: 6px 0; }

    .card-line{
      display: grid;
      grid-template-columns: 72px 1fr 56px;
      gap: 10px;
      align-items: center;
      padding: 8px 12px;
      border-top: 1px solid rgba(55,65,81,0.45);
      font-size: 13px;
      color: #e5e7eb;
    }
    .card-line:first-child{ border-top: none; }

    .c-time{ font-variant-numeric: tabular-nums; color: rgba(209,213,219,0.9); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .c-name{ white-space: nowrap; overflow: hidden; text-overflow: ellipsis; min-width: 0; }
    .c-agg{ justify-self: end; display: inline-flex; align-items: center; justify-content: center; }

    .entry-rollup{
      display: flex;
      gap: 8px;
      padding: 8px 12px 10px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      border-top: 1px solid rgba(55,65,81,0.35);
    }
    .entry-chip{
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid rgba(75,85,99,0.75);
      background: rgba(2,6,23,0.55);
      color: #f9fafb;
      font-size: 12px;
      font-variant-numeric: tabular-nums;
      white-space: nowrap;
      box-shadow: 0 0 0 1px rgba(2,6,23,0.75);
    }

    /* Timeline (base) -------------------------------------- */
    .timeline-viewport{
      height: calc(100vh - var(--header-h) - var(--nav-h) - 24px);
      overflow:auto;
      border:1px solid var(--border);
      border-radius:12px;
      background:#fff;
      color:#111;
    }
    .timeline-grid{position:relative;min-height:100%}
    .timeline-axis{
      position:sticky;top:0;z-index:10;
      display:flex;align-items:stretch;
      background:#fff;border-bottom:1px solid var(--border);
      height:42px;
    }
    .timeline-axis-left{
      position:sticky;left:0;z-index:12;
      width:180px;min-width:180px;
      padding:10px 12px;
      font-weight:800;
      background:#fff;
      border-right:1px solid var(--border);
      color:#111;
    }
    .timeline-axis-right{position:relative;height:42px}
    .timeline-axis-cell{
      position:absolute;top:0;bottom:0;
      border-left:1px solid #eee;
      padding:10px 8px;
      font-size:12px;color:#555;
      background:transparent;
      font-variant-numeric: tabular-nums;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }
    .timeline-rows{position:relative}
    .timeline-row{display:flex;min-height:54px;border-bottom:1px solid #f0f0f0}
    .timeline-horse{
      position:sticky;left:0;z-index:9;
      width:180px;min-width:180px;
      padding:10px 12px;
      background:#fff;border-right:1px solid var(--border);
      cursor:pointer;
    }
    .timeline-horse-name{font-weight:800;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .timeline-lane{position:relative}
    .timeline-card{
      position:absolute;top:8px;height:38px;
      border:1px solid var(--border);
      border-radius:10px;
      background:#fafafa;
      padding:6px 8px;
      cursor:pointer;
      overflow:hidden;
    }
    .timeline-card-top{display:flex;justify-content:space-between;gap:10px}
    .timeline-card-class{font-weight:900;font-size:12px}
    .timeline-card-ring{font-weight:700;font-size:12px;color:#444;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .timeline-card-mid{display:flex;gap:10px;margin-top:2px;font-size:11px;color:#555}
    .timeline-card-status{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    /* Added (discussed): wrapped rollup grid + 4-col detail lines + timeline updates */
    .entry-rollup-grid{
      display: grid;
      grid-template-columns: repeat(3, max-content);
      gap: 8px;
      align-content: start;
      justify-content: start;
    }
    .entry-rollup-grid .entry-chip{
      max-width: 100%;
    }

    .card-line4{
      display:grid;
      grid-template-columns: 72px 56px 1fr 56px;
      gap:10px;
      align-items:center;
      padding: 8px 12px;
      border-top: 1px solid rgba(55,65,81,0.45);
      font-size: 13px;
      color: #e5e7eb;
    }
    .card-line4:first-child{ border-top: none; }
    .c4-a{ font-variant-numeric: tabular-nums; color: rgba(209,213,219,0.9); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .c4-b{ font-variant-numeric: tabular-nums; color: rgba(209,213,219,0.9); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .c4-c{ white-space: nowrap; overflow: hidden; text-overflow: ellipsis; min-width: 0; }
    .c4-d{ justify-self: end; display:inline-flex; align-items:center; justify-content:flex-end; white-space: nowrap; overflow:hidden; text-overflow: ellipsis; min-width:0; }

    .timeline-axis{ z-index: 30; }
    .timeline-axis-left{ z-index: 32; }
    .timeline-horse{ z-index: 20; }
    .timeline-card{ z-index: 1; }

    .timeline-axis-left,
    .timeline-horse{
      width:60px;
      min-width:60px;
      padding:10px 8px;
    }

    .timeline-card{
      height:auto;
      padding:6px 8px;
    }
    .timeline-card-row{
      display:grid;
      grid-template-columns: 52px 1fr 28px 46px;
      gap:8px;
      align-items:center;
      line-height: 1.05;
    }
    .timeline-card-row + .timeline-card-row{ margin-top: 4px; }

    .timeline-cell{
      display:block;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      font-variant-numeric: tabular-nums;
    }
    .timeline-cell--num{ font-weight: 900; }
    .timeline-cell--name{ font-weight: 800; }
    .timeline-cell--st{ text-transform: uppercase; letter-spacing: 0.03em; font-weight: 900; text-align:right; }
    .timeline-cell--time{ color: rgba(203,213,225,0.9); font-weight: 800; }
    .timeline-cell--ring{ color: rgba(203,213,225,0.9); font-weight: 800; }
    .timeline-cell--go{ color: rgba(203,213,225,0.9); font-weight: 800; text-align:left; }
    .timeline-cell--oog{ color: rgba(203,213,225,0.9); font-weight: 900; text-align:right; }

    .timeline-viewport{
      background: radial-gradient(circle at top, #111827 0, #020617 70%);
      color:#e5e7eb;
      border:1px solid rgba(75,85,99,0.65);
    }
    .timeline-axis{
      background: rgba(2,6,23,0.92);
      border-bottom:1px solid rgba(75,85,99,0.55);
    }
    .timeline-axis-left{
      background: rgba(2,6,23,0.92);
      color:#f9fafb;
      border-right:1px solid rgba(75,85,99,0.55);
    }
    .timeline-axis-cell{
      border-left:1px solid rgba(75,85,99,0.35);
      color: rgba(203,213,225,0.9);
    }
    .timeline-row{ border-bottom:1px solid rgba(75,85,99,0.22); }
    .timeline-horse{
      background: rgba(2,6,23,0.92);
      border-right:1px solid rgba(75,85,99,0.55);
      color:#f9fafb;
    }
    .timeline-card{
      background: rgba(17,24,39,0.92);
      border:1px solid rgba(75,85,99,0.65);
      color:#f9fafb;
      box-shadow: 0 8px 18px rgba(0,0,0,0.35);
    }
  
    /* Contract additions: filterbottom + row/badge styling */
    .filterbottom{
      position: sticky;
      bottom: 0;
      z-index: 6;
      border-top: 1px solid #27272f;
      background: #020617;
      box-shadow: 0 -14px 30px rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(12px);
      padding: 6px 6px 10px;
    }
    .filterbottom-row{
      display:flex;
      gap:8px;
      overflow-x:auto;
      -webkit-overflow-scrolling: touch;
      padding: 0;
    }
    .nav-btn.is-active{
      border-color: #e5e7eb;
      background: rgba(229,231,235,0.12);
    }

    .badge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width: 22px;
      height: 18px;
      padding: 0 6px;
      border-radius: 999px;
      border: 1px solid rgba(75,85,99,0.75);
      background: rgba(2,6,23,0.55);
      color:#f9fafb;
      font-size: 11px;
      font-variant-numeric: tabular-nums;
      white-space: nowrap;
      box-shadow: 0 0 0 1px rgba(2,6,23,0.75);
    }
    .badge-wrap{ display:inline-flex; gap:6px; align-items:center; justify-content:flex-end; }
    .badge--status-C{ background: rgba(16,185,129,0.14); border-color: rgba(16,185,129,0.5); }
    .badge--status-S{ background: rgba(59,130,246,0.14); border-color: rgba(59,130,246,0.5); }
    .badge--status-L{ background: rgba(245,158,11,0.16); border-color: rgba(245,158,11,0.55); }

    .badge--type-J{ background: rgba(244,63,94,0.14); border-color: rgba(244,63,94,0.55); }
    .badge--type-E{ background: rgba(168,85,247,0.14); border-color: rgba(168,85,247,0.55); }
    .badge--type-H{ background: rgba(34,197,94,0.14); border-color: rgba(34,197,94,0.55); }

    .badge--seq-O{ background: rgba(14,165,233,0.14); border-color: rgba(14,165,233,0.55); }
    .badge--seq-U{ background: rgba(148,163,184,0.14); border-color: rgba(148,163,184,0.55); }

    .card-line4.row--class{ font-size: 13px; font-weight: 600; }
    .card-line4.row--entry{ font-size: 12px; font-weight: 500; }
    .card-line4.row--trip{  font-size: 11px; font-weight: 500; opacity: 0.95; }

    .row-alt{ background: rgba(255,255,255,0.03); }
    .group-wrap.tint-C{ border-left: 3px solid rgba(16,185,129,0.6); }
    .group-wrap.tint-S{ border-left: 3px solid rgba(59,130,246,0.6); }
    .group-wrap.tint-L{ border-left: 3px solid rgba(245,158,11,0.65); }

    /* Auto-hide header/nav on scroll (toggled by app.js) ---------- */
    .app-header,
    .app-nav{
      transform: translateY(0);
      transition: transform 160ms ease, height 160ms ease, opacity 120ms ease;
      will-change: transform, height;
    }

    .app.hide-header .app-header{
      height: 0 !important;
      opacity: 0;
      transform: translateY(calc(-1 * var(--header-h)));
      border-bottom: 0;
      padding: 0;
      overflow: hidden;
      pointer-events: none;
    }

    .app.hide-nav .app-nav{
      height: 0 !important;
      opacity: 0;
      transform: translateY(var(--nav-h));
      border-top: 0;
      padding: 0;
      overflow: hidden;
      pointer-events: none;
    }


    /* Full Schedule-only accents -------------------------------- */
    .fs-banner{
      margin: 8px 0 2px;
      padding: 8px 12px;
      border: 1px solid rgba(75, 85, 99, 0.65);
      border-radius: 16px;
      background: rgba(17,24,39,0.65);
      color: rgba(229,231,235,0.95);
      font-size: 12px;
    }
    .group-wrap.has-watch{
      background: rgba(37,99,235,0.10);
      box-shadow: inset 0 0 0 1px rgba(37,99,235,0.18);
      border-radius: 12px;
      margin: 6px 8px;
      overflow: hidden;
    }
    .group-wrap.has-watch .card-line4.fs-watch{
      background: rgba(37,99,235,0.14);
      border-top-color: rgba(37,99,235,0.22);
    }
    .fs-muted{ color: rgba(209,213,219,0.75); }

  </style>
</head>
<body>
  <div id="app" class="app">
    <header class="app-header">
      <button class="header-back" id="fs-home" type="button" aria-label="Home">
        <span>&larr;</span>
      </button>
      <h1 class="header-title" id="header-title">Full Schedule</h1>
      <div class="header-spacer" aria-hidden="true"></div>
    </header>

    <main class="app-main" id="app-main">
      <div class="list-column" id="screen-root"></div>
    </main>
  </div>

  <script>
  (function() {
    'use strict';

    const DATA_SCHEDULE_URL = '/schedule/data/latest/watch_schedule.json';
    const DATA_TRIPS_URL    = '/schedule/data/latest/watch_trips.json';

    // watch_trips.json is expected to already be filtered to your watch horses.
    const root = document.getElementById('screen-root');
    const homeBtn = document.getElementById('fs-home');

    if (homeBtn) {
      homeBtn.addEventListener('click', function() {
        window.location.href = '/schedule/';
      });
    }

    function el(tag, cls, txt) {
      const n = document.createElement(tag);
      if (cls) n.className = cls;
      if (txt != null) n.textContent = String(txt);
      return n;
    }

    function clearRoot() {
      while (root.firstChild) root.removeChild(root.firstChild);
    }

    function safeNum(v, dflt) {
      const n = Number(v);
      return Number.isFinite(n) ? n : dflt;
    }

    function timeToMinutes(t) {
      if (!t) return null;
      const s0 = String(t).trim();
      if (!s0) return null;

      let m = s0.match(/^(\d{1,2}):(\d{2})\s*([AaPp])\s*([Mm])?$/);
      if (m) {
        let hh = parseInt(m[1], 10);
        const mm = parseInt(m[2], 10);
        const ap = m[3].toUpperCase();
        if (ap === 'A') {
          if (hh === 12) hh = 0;
        } else {
          if (hh !== 12) hh += 12;
        }
        return hh * 60 + mm;
      }

      m = s0.match(/^(\d{1,2}):(\d{2})(?::(\d{2}))?$/);
      if (m) {
        const hh = parseInt(m[1], 10);
        const mm = parseInt(m[2], 10);
        if (hh < 0 || hh > 23) return null;
        if (mm < 0 || mm > 59) return null;
        return hh * 60 + mm;
      }

      return null;
    }

    function fmtTimeShort(t) {
      const mins = timeToMinutes(t);
      if (mins == null) return String(t || '').trim();

      const h24 = Math.floor(mins / 60) % 24;
      const m = mins % 60;

      const ap = h24 >= 12 ? 'P' : 'A';
      let h = h24 % 12;
      if (h === 0) h = 12;
      return `${h}:${String(m).padStart(2,'0')}${ap}`;
    }

    function statusRank(statusText) {
      const s = String(statusText || '').toLowerCase();
      if (s.includes('underway')) return 3;
      if (s.includes('upcoming')) return 2;
      if (s.includes('complete')) return 1;
      return 0;
    }

    function statusLetter(statusText) {
      const s = String(statusText || '').toLowerCase();
      if (s.includes('underway')) return 'L';
      if (s.includes('upcoming')) return 'S';
      if (s.includes('complete')) return 'C';
      return '';
    }

    function statusTintClass(statusText) {
      const s = String(statusText || '').toLowerCase();
      if (s.includes('underway')) return 'tint-L';
      if (s.includes('upcoming')) return 'tint-S';
      if (s.includes('complete')) return 'tint-C';
      return '';
    }

    function makeBadge(txt, cls) {
      return el('span', 'badge' + (cls ? (' ' + cls) : ''), txt);
    }

    function addLine4(parent, a, b, cNodeOrText, dNodeOrText, rowCls, extraCls) {
      const line = el('div', 'card-line4' + (rowCls ? (' ' + rowCls) : '') + (extraCls ? (' ' + extraCls) : ''));

      const cA = el('div', 'c4-a', a || '');
      const cB = el('div', 'c4-b', b || '');
      const cC = el('div', 'c4-c');
      const cD = el('div', 'c4-d');

      if (cNodeOrText != null && typeof cNodeOrText === 'object' && cNodeOrText.nodeType) cC.appendChild(cNodeOrText);
      else if (cNodeOrText != null) cC.textContent = String(cNodeOrText);

      if (dNodeOrText != null && typeof dNodeOrText === 'object' && dNodeOrText.nodeType) cD.appendChild(dNodeOrText);
      else if (dNodeOrText != null) cD.textContent = String(dNodeOrText);

      line.appendChild(cA);
      line.appendChild(cB);
      line.appendChild(cC);
      line.appendChild(cD);

      parent.appendChild(line);
    }

    function coerceArray(payload) {
      if (Array.isArray(payload)) return payload;
      if (payload && Array.isArray(payload.items)) return payload.items;
      if (payload && Array.isArray(payload.rows)) return payload.rows;
      if (payload && Array.isArray(payload.schedule)) return payload.schedule;
      return [];
    }

    function isWatchTrip(t) {
      // Treat every row in watch_trips.json as "watch".
      return true;
    }

    async function fetchJson(url) {
      const res = await fetch(url, { cache: 'no-store' });
      if (!res.ok) throw new Error(`Fetch failed ${res.status}`);
      return await res.json();
    }

    function render(scheduleRows, tripsRows) {
      clearRoot();

      const b = el('div', 'fs-banner');
      b.innerHTML = '<span class="fs-muted">Data:</span> watch_schedule.json (full) + watch_trips.json (overlay for horses 22/23)';
      root.appendChild(b);

      // Build watch overlay map: ring|group -> entry set + number set
      const watchByGroup = new Map();
      for (const t of (tripsRows || [])) {
        if (!isWatchTrip(t)) continue;
        const rn = (t && t.ring_number != null) ? String(t.ring_number) : '';
        const gid = (t && t.class_group_id != null) ? String(t.class_group_id) :
                    (t && t.class_groupxclasses_id != null) ? String(t.class_groupxclasses_id) :
                    '';
        if (!rn || !gid) continue;

        const key = rn + '|' + gid;
        if (!watchByGroup.has(key)) watchByGroup.set(key, { entries: new Set(), horses: new Set(), trips: 0 });
        const w = watchByGroup.get(key);

        const eKey = (t.entryxclasses_uuid != null ? String(t.entryxclasses_uuid) :
                     t.entry_id != null ? String(t.entry_id) :
                     t.backNumber != null ? 'B' + String(t.backNumber) :
                     t.entryNumber != null ? 'E' + String(t.entryNumber) :
                     t.horseName ? 'H' + String(t.horseName) : null);

        if (eKey) w.entries.add(eKey);

        if (t && t.horseName) w.horses.add(String(t.horseName));

        w.trips++;
      }

      // Build schedule hierarchy: ring -> group -> classes
      const ringMap = new Map();

      for (const r of (scheduleRows || [])) {
        const rnRaw = (r && r.ring_number != null) ? r.ring_number : null;
        const rn = rnRaw != null ? String(rnRaw) : '';
        if (!rn) continue;

        const ringName = r.ringName ? String(r.ringName) :
                         r.ring_name ? String(r.ring_name) :
                         ('Ring ' + rn);

        if (!ringMap.has(rn)) {
          ringMap.set(rn, {
            ring_number: rn,
            ringName,
            groups: new Map()
          });
        }
        const ring = ringMap.get(rn);

        const gidRaw = (r.class_group_id != null) ? r.class_group_id :
                       (r.class_groupxclasses_id != null) ? r.class_groupxclasses_id :
                       null;
        const gid = gidRaw != null ? String(gidRaw) : '';
        if (!gid) continue;

        if (!ring.groups.has(gid)) {
          ring.groups.set(gid, {
            class_group_id: gid,
            group_name: r.group_name ? String(r.group_name) : '',
            latestStatus: r.latestStatus ? String(r.latestStatus) : '',
            classes: []
          });
        }

        const g = ring.groups.get(gid);

        if (r.latestStatus && !g.latestStatus) g.latestStatus = String(r.latestStatus);

        const cls = {
          class_id: r.class_id != null ? String(r.class_id) : '',
          class_number: r.class_number != null ? String(r.class_number) : '',
          class_name: r.class_name != null ? String(r.class_name) : '',
          class_type: r.class_type != null ? String(r.class_type) : '',
          latestStart: (r.latestStart || r.lastestStart || '')
        };
        g.classes.push(cls);
      }

      const ringsAll = Array.from(ringMap.values()).sort((a, b) => safeNum(a.ring_number, 999999) - safeNum(b.ring_number, 999999));

      if (ringsAll.length === 0) {
        root.appendChild(el('div', 'card-line', 'No schedule rows found.'));
        return;
      }

      for (const ring of ringsAll) {
        const card = el('div', 'card');
        card.id = 'ring-' + String(ring.ring_number);
        const body = el('div', 'card-body');
        card.appendChild(body);

        let classCount = 0;
        for (const g of ring.groups.values()) classCount += (g.classes ? g.classes.length : 0);
        addLine4(body, ring.ringName, '', el('span','', ''), String(classCount), 'row--class', '');

        const groups = Array.from(ring.groups.values()).sort((a, b) => {
          const ar = statusRank(a.latestStatus);
          const br = statusRank(b.latestStatus);
          if (ar !== br) return br - ar;
          return String(a.group_name || '').localeCompare(String(b.group_name || ''));
        });

        for (const g of groups) {
          if (!g.classes || g.classes.length === 0) continue;

          const gKey = String(ring.ring_number) + '|' + String(g.class_group_id);
          const w = watchByGroup.get(gKey);
          const hasWatch = !!(w && w.entries && w.entries.size > 0);

          const gWrap = el('div', 'group-wrap ' + statusTintClass(g.latestStatus) + (hasWatch ? ' has-watch' : ''));
          body.appendChild(gWrap);

          // Group header row
          const gStart = (() => {
            let best = null;
            for (const c of g.classes) {
              const mm = timeToMinutes(c.latestStart);
              if (mm == null) continue;
              if (best == null || mm < best) best = mm;
            }
            if (best == null) return '';
            const hh = Math.floor(best/60);
            const mm2 = best%60;
            return fmtTimeShort(`${hh}:${String(mm2).padStart(2,'0')}`);
          })();

          const statusL = statusLetter(g.latestStatus);
          const badge = statusL ? makeBadge(statusL, 'badge--status') : el('span','', '');
          const nameNode = document.createTextNode(String(g.group_name || ''));

          let dNode = badge;
          if (hasWatch) {
            const horses = w && w.horses ? Array.from(w.horses).sort((a,b)=>String(a).localeCompare(String(b))) : [];
            let horseTxt = '';
            if (horses.length === 1) horseTxt = horses[0];
            else if (horses.length === 2) horseTxt = horses[0] + ', ' + horses[1];
            else if (horses.length > 2) horseTxt = horses[0] + ', ' + horses[1] + ' +' + String(horses.length - 2);

            const parts = [];
            parts.push('watch: ' + String(w.entries.size));
            parts.push('trips: ' + String(w.trips));
            if (horseTxt) parts.push(horseTxt);
            dNode = el('span', 'fs-muted', parts.join(' • '));
          }
• ${w.entries.size}` : String(w.entries.size));
          }

          addLine4(gWrap, gStart, '', nameNode, dNode, 'row--class', hasWatch ? 'fs-watch' : '');

          const classes = g.classes.slice().sort((a, b) => {
            const am = timeToMinutes(a.latestStart);
            const bm = timeToMinutes(b.latestStart);
            if (am != null && bm != null && am !== bm) return am - bm;
            const an = safeNum(a.class_number, 999999);
            const bn = safeNum(b.class_number, 999999);
            if (an !== bn) return an - bn;
            return String(a.class_name || '').localeCompare(String(b.class_name || ''));
          });

          let stripe = 0;
          for (const c of classes) {
            stripe++;
            const stL = statusLetter(g.latestStatus);
            const stBadge = stL ? makeBadge(stL, 'badge--status') : el('span','', '');
            addLine4(
              gWrap,
              fmtTimeShort(c.latestStart || ''),
              c.class_number || '',
              document.createTextNode(String(c.class_name || '')),
              stBadge,
              'row--class',
              (stripe % 2 === 0 ? 'row-alt' : '')
            );
          }
        }

        root.appendChild(card);
      }
    }

    (async function init() {
      clearRoot();
      root.appendChild(el('div', 'card-line', 'Loading full schedule...'));

      let schedule = [];
      let trips = [];

      try {
        const s = await fetchJson(DATA_SCHEDULE_URL);
        schedule = coerceArray(s);
      } catch (e) {
        clearRoot();
        root.appendChild(el('div', 'card-line', 'Full Schedule unavailable (watch_schedule.json not reachable).'));
        return;
      }

      try {
        const t = await fetchJson(DATA_TRIPS_URL);
        trips = coerceArray(t);
      } catch (e) {
        trips = [];
      }

      render(schedule, trips);
    })();
  })();
  </script>
</body>
</html>
