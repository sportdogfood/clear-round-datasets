<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="robots" content="noindex,nofollow" />
<title>Schedule One-Page</title>
<style>
  /* ===== PRINT CONTRACT ===== */
  @page { size: Letter; margin: 0.25in; }
  html, body { height: 100%; }
  body {
    margin: 0;
    background: #fff;
    color: #111;
    font-family: Arial, Helvetica, sans-serif;
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
  }

  /* Page canvas sized exactly to printable area */
  .page {
    width: calc(8.5in - 0.5in);
    height: calc(11in - 0.5in);
    margin: 0.25in auto;
    box-sizing: border-box;
    position: relative;
    transform-origin: top left;
  }

  /* Header */
  .report-header {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    padding: 0 0 0.10in 0;
    border-bottom: 2px solid #111;
    margin-bottom: 0.10in;
  }
  .report-title {
    font-size: 16pt;
    font-weight: 800;
    line-height: 1.05;
  }
  .report-sub {
    font-size: 10pt;
    font-weight: 700;
    white-space: nowrap;
  }

  /* Two columns */
  .cols {
    display: flex;
    gap: 0.18in;
    height: calc(11in - 0.5in - 0.55in); /* page height minus header block */
    box-sizing: border-box;
  }
  .col {
    flex: 1 1 0;
    height: 100%;
    overflow: hidden;
  }

  /* Ring block */
  .ring {
    border: 1px solid #111;
    margin-bottom: 0.12in;
    break-inside: avoid;
    page-break-inside: avoid;
  }
  .ring-head {
    background: #111;
    color: #fff;
    padding: 0.06in 0.08in;
    font-size: 12pt;
    font-weight: 900;
    letter-spacing: 0.2px;
  }

  /* Groups */
  .group {
    border-top: 1px solid #111;
    padding: 0.06in 0.08in 0.07in 0.08in;
  }
  .group:first-of-type { border-top: none; }

  /* group_display over group_name */
  .group-display {
    text-align: right;
    font-size: 11pt;
    font-weight: 900;
    line-height: 1.05;
    margin-bottom: 0.02in;
    color: #111;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .group-name {
    font-size: 11pt;
    font-weight: 900;
    line-height: 1.1;
    margin-bottom: 0.04in;
  }

  /* Classes */
  .class-row {
    display: grid;
    grid-template-columns: 0.75in 1fr;
    column-gap: 0.08in;
    align-items: baseline;
    padding: 0.01in 0;
    font-size: 9.5pt;
    line-height: 1.15;
  }
  .class-time {
    font-weight: 800;
    white-space: nowrap;
  }
  .class-text {
    font-weight: 600;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .muted { color: #444; font-weight: 600; }

  /* Screen preview */
  @media screen {
    body { padding: 16px 0; }
    .page { box-shadow: 0 0 0 1px #bbb; }
  }
</style>
</head>
<body>
  <div class="page" id="page">
    <div class="report-header">
      <div class="report-title" id="title">Schedule</div>
      <div class="report-sub" id="sub"> </div>
    </div>
    <div class="cols" id="cols">
      <div class="col" id="col1"></div>
      <div class="col" id="col2"></div>
    </div>
  </div>

<script>
(function(){
  const DEFAULT_DAY_KEY = "200000044-20251231"; // change if needed

  function $(id){ return document.getElementById(id); }

  function getDayKey(){
    const h = (location.hash || "").replace(/^#/, "").trim();
    return h || DEFAULT_DAY_KEY;
  }

  async function loadJson(dayKey){
    const url = `${dayKey}.json`;
    const res = await fetch(url, { cache: "no-store" });
    if(!res.ok){
      const txt = await res.text().catch(()=> "");
      throw new Error(`Failed to load ${url} (${res.status}) ${txt.slice(0,200)}`);
    }
    return await res.json();
  }

  function clearColumns(){
    $("col1").innerHTML = "";
    $("col2").innerHTML = "";
    $("page").style.transform = "scale(1)";
  }

  function el(tag, cls, text){
    const n = document.createElement(tag);
    if(cls) n.className = cls;
    if(text !== undefined && text !== null) n.textContent = text;
    return n;
  }

  function render(schedule){
    const meta = schedule && schedule.meta ? schedule.meta : {};
    const rings = Array.isArray(schedule && schedule.rings) ? schedule.rings : [];

    const showId = meta.show_id ?? "";
    const showDate = meta.show_date ?? "";
    const showTitle = (meta.show_title || "").trim();

    $("title").textContent = showTitle ? showTitle : `Show ${showId}`;
    $("sub").textContent = showDate ? `Date: ${showDate}` : "";

    const ringNodes = [];

    for(const ring of rings){
      const ringName = (ring.ring_name || ring.ring_nickname || "").trim();
      if(!ringName) continue;

      const ringBox = el("div", "ring");
      ringBox.appendChild(el("div", "ring-head", ringName));

      const groups = Array.isArray(ring.groups) ? ring.groups : [];
      for(const g of groups){
        const group = el("div", "group");

        const gd = (g.group_display || "").trim();
        if(gd){
          group.appendChild(el("div", "group-display", gd));
        } else {
          // maintain vertical rhythm even when empty
          group.appendChild(el("div", "group-display muted", ""));
        }

        const glabel = (g.group_label || g.group_name || "").trim();
        group.appendChild(el("div", "group-name", glabel));

        const classes = Array.isArray(g.classes) ? g.classes : [];
        let lastTime = "";
        for(const c of classes){
          const t = (c.start_display || "").trim();
          const showTime = (t && t !== lastTime) ? t : "";
          if(t) lastTime = t;

          const row = el("div", "class-row");
          row.appendChild(el("div", "class-time", showTime));

          const cn = c.class_number ?? "";
          const cname = (c.class_name || "").trim();
          const text = (cn ? `${cn} - ` : "") + cname;
          row.appendChild(el("div", "class-text", text));

          group.appendChild(row);
        }

        ringBox.appendChild(group);
      }

      ringNodes.push(ringBox);
    }

    packIntoTwoColumns(ringNodes);
    fitToOnePage();
  }

  function packIntoTwoColumns(nodes){
    const c1 = $("col1");
    const c2 = $("col2");
    c1.innerHTML = "";
    c2.innerHTML = "";

    // measure available height
    const cols = $("cols");
    const maxH = cols.getBoundingClientRect().height;

    let h1 = 0;
    let h2 = 0;

    // attach to a hidden measuring container (use col1 temporarily)
    for(const n of nodes){
      c1.appendChild(n);
    }

    // now rebuild into columns with measured heights
    const measured = Array.from(c1.children).map(node => ({ node, h: node.getBoundingClientRect().height }));
    c1.innerHTML = "";

    for(const item of measured){
      // place into the shorter column, but keep within page height when possible
      const target = (h1 <= h2) ? c1 : c2;
      const currH = (h1 <= h2) ? h1 : h2;

      // if it doesn't fit in the chosen column but fits in the other, swap
      if(currH + item.h > maxH){
        const other = (target === c1) ? c2 : c1;
        const otherH = (target === c1) ? h2 : h1;
        if(otherH + item.h <= maxH){
          other.appendChild(item.node);
          if(other === c1) h1 += item.h; else h2 += item.h;
          continue;
        }
      }

      target.appendChild(item.node);
      if(target === c1) h1 += item.h; else h2 += item.h;
    }
  }

  function fitToOnePage(){
    const page = $("page");
    const rect = page.getBoundingClientRect();
    const maxW = rect.width;
    const maxH = rect.height;

    // content height is header + cols; if cols overflow, scale down
    const colsRect = $("cols").getBoundingClientRect();
    const headerRect = page.querySelector(".report-header").getBoundingClientRect();

    const usedH = (colsRect.bottom - headerRect.top);
    const scaleH = usedH > maxH ? (maxH / usedH) : 1;

    const scale = Math.min(1, scaleH);
    page.style.transform = `scale(${scale})`;
  }

  async function run(){
    clearColumns();
    const dayKey = getDayKey();
    try{
      const sched = await loadJson(dayKey);
      render(sched);
    } catch(err){
      $("title").textContent = "Schedule load error";
      $("sub").textContent = String(err.message || err);
    }
  }

  window.addEventListener("hashchange", run);
  run();
})();
</script>
</body>
</html>
