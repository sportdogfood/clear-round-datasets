<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>CRT Schedule (One Page Print)</title>

<style>
  :root{
    --fg:#111;
    --muted:#666;
    --line:#111;
    --border:#d0d0d0;
    --ring:#0b5d47;
    --ringPrint:#000;
    --groupTeam:rgba(204,204,204,.43);
    --scale: 1;
    --cols: 2;
  }

  *{box-sizing:border-box}
  body{
    margin:0;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    color:var(--fg);
    background:#fff;
  }

  /* Screen preview as a single Letter page */
  .page{
    width: 8.5in;
    height: 11in;
    padding: 0.25in;
    margin: 12px auto;
    background:#fff;
    overflow:hidden;
  }

  @media print{
    body{background:#fff;}
    .page{
      width:auto;
      height:auto;
      padding:0;
      margin:0;
      overflow:visible;
    }
  }

  .topbar{
    display:flex;
    align-items:flex-end;
    justify-content:space-between;
    gap:10px;
    padding:0 0 6px 0;
  }
  .title{font-weight:900; font-size:14px; line-height:1.1;}
  .subtitle{color:var(--muted); font-size:10px; margin-top:2px;}
  .controls{display:flex; align-items:center; gap:8px; flex-wrap:wrap;}
  .btn{
    border:1px solid var(--border);
    background:#fff;
    padding:3px 10px;
    font-size:12px;
    border-radius:6px;
    cursor:pointer;
  }

  /* scaled content wrapper */
  .wrap{
    transform: scale(var(--scale));
    transform-origin: top left;
    width: calc(100% / var(--scale));
  }

  /* dynamic columns */
  .cols{
    display:grid;
    grid-template-columns: repeat(var(--cols), 1fr);
    gap: 0.12in;
    align-items:start;
  }
  .col{display:flex; flex-direction:column; gap:2px; min-width:0;}

  .ring{
    border:1px solid #000;
    page-break-inside: avoid;
    break-inside: avoid;
  }
  .ring-head{
    background:var(--ring);
    color:#fff;
    padding:4px 6px;
    font-weight:900;
    font-size:10px;
    letter-spacing:.02em;
  }

  /* highlight groups that have a team (group_display present) */
  .group.has-team{
    background: var(--groupTeam);
    page-break-inside: avoid;
    break-inside: avoid;
  }
  .group-head{
    padding:4px 6px 1px 6px;
  }

  /* group_display above group_name */
  .gdisplay{
    font-size:11px;
    font-weight:600;
    text-align:right;
    text-transform: uppercase;
    margin-bottom:-6px;
    margin-right: 20px;
    margin-left: 10px;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .gname{
    font-weight:900;
    font-size:10px;
    line-height:1.1;
    text-align:left;
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
    display:none;
  }

  .class-list{
    padding:3px 6px 4px 6px;
    border-bottom: 1px solid #8e8c8c;
  }

  .c{
    display:grid;
    grid-template-columns:46px 1fr;
    column-gap:6px;
    line-height:1.05;
    padding:2px 0;
    min-width:0;
  }
  .t{font-weight:600; font-size:9px; white-space:nowrap;}
  .n{
    font-size:9px;
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
    min-width:0;
  }
  .muted{color:var(--muted);}
  .err{white-space:pre-wrap; color:#b00020; padding:12px; font-size:12px; border:1px solid #b00020;}

  /* Print rules */
  @media print{
    @page{ size: Letter; margin: 0.25in; }
    .controls{display:none !important;}
    .page{box-shadow:none;}
    body{-webkit-print-color-adjust: exact; print-color-adjust: exact;}
    .ring-head{background:var(--ringPrint);}

    body.tight .ring-head{padding:3px 5px; font-size:9px;}
    body.tight .group-head{padding:2px 5px;}
    body.tight .gdisplay{font-size:9px; margin-bottom:1px;}
    body.tight .class-list{padding:2px 5px 3px 5px;}
    body.tight .c{grid-template-columns:42px 1fr; column-gap:5px; padding:1px 0;}
    body.tight .t{font-size:8px;}
    body.tight .n{font-size:8px;}
  }
</style>
</head>

<body>
  <div class="page" id="page">
    <div class="topbar" id="topbar">
      <div>
        <div class="title" id="title">Schedule</div>
        <div class="subtitle" id="subtitle"></div>
      </div>
      <div class="controls">
        <button class="btn" id="btnPrint" type="button">Print</button>
      </div>
    </div>

    <div class="wrap" id="wrap">
      <div class="cols" id="cols"></div>
    </div>
  </div>

<script>
/*
  EXPECTED:
    window.scheduleData = [ ...rows... ]
  Row fields used (safe if missing):
    show_days_report_title, show_days_display_date,
    ring_number, ring_nickname,
    group_display, group_name,
    start_display, class_number, class_name
*/

(function(){
  const $ = (id) => document.getElementById(id);

  function norm(v){ return v == null ? "" : String(v); }

  function parseTimeToMin(t){
    t = norm(t).trim();
    const m = t.match(/^(\d{1,2}):(\d{2})\s*(AM|PM)$/i);
    if (!m) return 9999;
    let hh = parseInt(m[1], 10);
    const mm = parseInt(m[2], 10);
    const ap = m[3].toUpperCase();
    if (ap === "PM" && hh !== 12) hh += 12;
    if (ap === "AM" && hh === 12) hh = 0;
    return hh * 60 + mm;
  }

  function byRing(rows){
    const map = new Map();
    for (const r of rows){
      const rn = norm(r.ring_number);
      const nick = norm(r.ring_nickname);
      const key = rn + "||" + nick;
      if (!map.has(key)) map.set(key, { ring_number: rn, ring_nickname: nick, rows: [] });
      map.get(key).rows.push(r);
    }
    return Array.from(map.values()).sort((a,b) => (Number(a.ring_number||0) - Number(b.ring_number||0)) || (a.ring_nickname||"").localeCompare(b.ring_nickname||""));
  }

  function byGroup(rows){
    const map = new Map();
    for (const r of rows){
      const gdisp = norm(r.group_display);
      const gname = norm(r.group_name);
      const key = gdisp + "||" + gname;
      if (!map.has(key)) map.set(key, { group_display: gdisp, group_name: gname, rows: [] });
      map.get(key).rows.push(r);
    }
    return Array.from(map.values());
  }

  function el(tag, cls, text){
    const x = document.createElement(tag);
    if (cls) x.className = cls;
    if (text != null) x.textContent = text;
    return x;
  }

  function buildRingBlock(ring){
    // ring container
    const ringEl = el("div", "ring");

    const head = el("div", "ring-head", `R${norm(ring.ring_number)} ${norm(ring.ring_nickname)}`.trim());
    ringEl.appendChild(head);

    // groups
    const groups = byGroup(ring.rows);
    // stable ordering: group_display then first class time
    groups.sort((a,b) => {
      const ad = (a.group_display||"").localeCompare(b.group_display||"");
      if (ad) return ad;
      const at = Math.min(...a.rows.map(x => parseTimeToMin(x.start_display)));
      const bt = Math.min(...b.rows.map(x => parseTimeToMin(x.start_display)));
      return at - bt;
    });

    for (const g of groups){
      const hasTeam = !!norm(g.group_display).trim();
      const gWrap = el("div", "group" + (hasTeam ? " has-team" : ""));

      const gHead = el("div", "group-head");
      if (hasTeam) gHead.appendChild(el("div", "gdisplay", g.group_display));
      gHead.appendChild(el("div", "gname", g.group_name));
      gWrap.appendChild(gHead);

      const list = el("div", "class-list");

      // classes sorted by time then class_number
      g.rows.sort((a,b) => {
        const ta = parseTimeToMin(a.start_display);
        const tb = parseTimeToMin(b.start_display);
        if (ta !== tb) return ta - tb;
        const ca = Number(a.class_number || 0);
        const cb = Number(b.class_number || 0);
        return ca - cb;
      });

      for (const r of g.rows){
        const time = norm(r.start_display);
        const cn = norm(r.class_number);
        const name = norm(r.class_name);
        const line = el("div", "c");
        line.appendChild(el("div", "t", time));
        line.appendChild(el("div", "n", (cn ? (cn + " ") : "") + name));
        list.appendChild(line);
      }

      gWrap.appendChild(list);
      ringEl.appendChild(gWrap);
    }

    return ringEl;
  }

  function chooseColumnCount(rows){
    // bump columns for huge schedules to reduce scaling
    const n = rows.length;
    if (n > 220) return 4;
    if (n > 140) return 3;
    return 2;
  }

  function renderSchedule(rows){
    const colsEl = $("cols");
    colsEl.innerHTML = "";

    if (!Array.isArray(rows) || !rows.length){
      colsEl.appendChild(el("div", "err", "No schedule data found.\nSet window.scheduleData = [...] before this script runs."));
      return;
    }

    // header
    const t = norm(rows[0].show_days_report_title) || "Schedule";
    const d = norm(rows[0].show_days_display_date) || "";
    $("title").textContent = t;
    $("subtitle").textContent = d;

    // columns
    const colCount = chooseColumnCount(rows);
    document.documentElement.style.setProperty("--cols", String(colCount));

    const colEls = [];
    for (let i=0;i<colCount;i++){
      const c = el("div", "col");
      colsEl.appendChild(c);
      colEls.push(c);
    }

    // build ring blocks and greedy-balance by weight
    const rings = byRing(rows);
    const weights = new Array(colCount).fill(0);

    for (const ring of rings){
      const block = buildRingBlock(ring);
      const w = 2 + ring.rows.length; // simple weight
      let best = 0;
      for (let i=1;i<colCount;i++){
        if (weights[i] < weights[best]) best = i;
      }
      colEls[best].appendChild(block);
      weights[best] += w;
    }

    // fit to one page
    requestAnimationFrame(() => {
      autoFitToLetter();
      requestAnimationFrame(autoFitToLetter);
    });
  }

  function autoFitToLetter(){
    const page = $("page");
    const topbar = $("topbar");
    const cols = $("cols");

    // reset
    document.documentElement.style.setProperty("--scale", "1");
    document.body.classList.remove("tight");

    const availH = page.clientHeight - topbar.offsetHeight - 2;
    const availW = page.clientWidth;

    // measure unscaled content
    const contentH = cols.scrollHeight;
    const contentW = cols.scrollWidth;

    const sH = contentH ? (availH / contentH) : 1;
    const sW = contentW ? (availW / contentW) : 1;

    const scale = Math.max(0.35, Math.min(1, sH, sW));
    document.documentElement.style.setProperty("--scale", String(scale));

    if (scale < 0.86) document.body.classList.add("tight");
  }

  function beforePrint(){
    autoFitToLetter();
    // one more pass to settle layout before print dialog
    autoFitToLetter();
  }

  $("btnPrint").addEventListener("click", () => {
    beforePrint();
    window.print();
  });

  window.addEventListener("resize", () => autoFitToLetter());
  window.addEventListener("beforeprint", () => beforePrint());

  // expose helper for late injection
  window.setScheduleData = function(rows){
    window.scheduleData = rows;
    renderSchedule(rows);
  };

  // initial render from whatever global exists
  const rows =
    window.scheduleData ||
    window.SCHEDULE_DATA ||
    window.schedule_rows ||
    window.rows ||
    [];

  renderSchedule(rows);
})();
</script>
</body>
</html>