<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Schedules</title>
  <style>
    :root{
      --bg:#0f0f10;
      --card:#161618;
      --fg:#ffffff;
      --muted:rgba(255,255,255,.72);
      --border:rgba(255,255,255,.14);
      --accent:#22c55e;
      --btn:#1f1f22;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:var(--bg);
      color:var(--fg);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      padding:16px 14px calc(16px + env(safe-area-inset-bottom, 0px));
    }

    /* Mobile-only */
    @media (min-width: 860px){
      body{display:flex; align-items:center; justify-content:center;}
      .wrap{max-width:520px}
      .desktop-note{
        display:block;
        border:1px solid var(--border);
        border-radius:14px;
        padding:14px;
        background:var(--card);
        color:var(--muted);
        text-align:center;
      }
      .app{display:none;}
    }
    @media (max-width: 859px){
      .desktop-note{display:none;}
      .app{display:block;}
    }

    .wrap{max-width:520px; margin:0 auto;}
    .top{
      border:1px solid var(--border);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border-radius:16px;
      padding:14px 14px 12px;
      margin-bottom:12px;
    }
    .title{
      font-weight:900;
      letter-spacing:.01em;
      font-size:16px;
      line-height:1.15;
    }
    .meta{
      margin-top:6px;
      color:var(--muted);
      font-size:12px;
      line-height:1.3;
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .accent{color:var(--accent); font-weight:800;}

    .grid{
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .btn{
      display:block;
      text-decoration:none;
      color:var(--fg);
      background:var(--btn);
      border:1px solid var(--border);
      border-radius:16px;
      padding:14px 14px;
      box-shadow: 0 10px 18px rgba(0,0,0,.22);
    }
    .btn:active{transform:translateY(1px)}
    .btn .label{
      font-weight:900;
      font-size:14px;
      line-height:1.2;
      margin-bottom:6px;
    }
    .btn .sub{
      font-size:12px;
      color:var(--muted);
      line-height:1.25;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .btn .sub.empty{display:none;}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="desktop-note">
      Open <b>/schedules.html</b> on a phone for the mobile menu.
    </div>

    <div class="app">
      <div class="top">
        <div class="title">üõ°Ô∏è CWF Schedule</div>
        <div class="meta">
          <div id="displayDate">‚Äî</div>
          <div>Time: <span class="accent" id="nowTime">‚Äî</span></div>
        </div>
      </div>

      <div class="grid">
        <a class="btn" id="btnPrinted" href="#">
          <div class="label">Printed - Schedule</div>
          <div class="sub" id="subPrinted"></div>
        </a>

        <a class="btn" id="btnMobile" href="#">
          <div class="label">Mobile - Schedule</div>
          <div class="sub" id="subMobile"></div>
        </a>

        <a class="btn" id="btnWatch" href="#">
          <div class="label">Mobile - Watch</div>
          <div class="sub" id="subWatch"></div>
        </a>

        <a class="btn" id="btnTack" href="https://blog.clearroundtravel.com/lists/index.html">
          <div class="label">Tacklists</div>
          <div class="sub empty" id="subTack"></div>
        </a>
      </div>
    </div>
  </div>

<script>
  /**
   * /schedules.html
   *
   * Latest pointers (overwritten by you):
   * - https://blog.clearroundtravel.com/latest/schedule.json  (for v2 + v5)
   * - https://blog.clearroundtravel.com/latest/team.json      (for v3)
   *
   * Notes:
   * - No ring anchor in links.
   * - Published times come from Last-Modified headers of the latest files.
   */

  const TIMEZONE = "America/New_York";
  const PUBLISH_INTERVAL_MS = 30 * 60 * 1000;

  const LATEST_SCHEDULE_URL = "https://blog.clearroundtravel.com/latest/schedule.json";
  const LATEST_TEAM_URL     = "https://blog.clearroundtravel.com/latest/team.json";

  const fmtTime = (ms)=> new Intl.DateTimeFormat("en-US", {
    timeZone: TIMEZONE,
    hour:"numeric",
    minute:"2-digit"
  }).format(new Date(ms));

  function toYYYYMMDDFromISO(iso){
    // "2026-01-18" -> "20260118"
    const s = String(iso || "").trim();
    const m = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
    return m ? (m[1] + m[2] + m[3]) : "";
  }

  function setSub(id, text){
    const el = document.getElementById(id);
    if(!el) return;
    el.textContent = text || "";
    if(!text) el.classList.add("empty");
    else el.classList.remove("empty");
  }

  async function fetchJsonAndLastModified(url){
    const res = await fetch(url, { cache:"no-store" });
    const txt = await res.text();
    if(!res.ok) throw new Error(`Fetch failed ${res.status} for ${url}`);
    const lastMod = res.headers.get("last-modified");
    const ms = lastMod ? Date.parse(lastMod) : null;

    let json = null;
    try { json = JSON.parse(txt); } catch(e) {}

    return { json, lastModifiedMs: (Number.isFinite(ms) ? ms : null) };
  }

  function startClock(){
    const nowEl = document.getElementById("nowTime");
    const tick = ()=>{
      nowEl.textContent = fmtTime(Date.now());
    };
    tick();
    setInterval(tick, 1000 * 15);
  }

  function setHeaderDateFromRows(rows){
    const el = document.getElementById("displayDate");
    const first = (Array.isArray(rows) && rows.length) ? rows[0] : {};
    const d =
      first.show_days_display_date ??
      first.show_display_date ??
      first.show_date ??
      first.showDate ??
      "";
    el.textContent = d ? String(d) : "‚Äî";
  }

  function setLinksFromSchedule(rows){
    const first = (Array.isArray(rows) && rows.length) ? rows[0] : {};
    const showId = String(first.show_id ?? first.showId ?? "").trim();
    const showDateISO = String(first.show_date ?? first.showDate ?? "").trim();
    const showDay = toYYYYMMDDFromISO(showDateISO);

    // v5 printed: keep your existing hash pattern if we can derive it
    const printedHref = (showId && showDay)
      ? `https://blog.clearroundtravel.com/schedule/data/schedule_onepage_v5.html#${showId}-${showDay}`
      : `https://blog.clearroundtravel.com/schedule/data/schedule_onepage_v5.html`;

    // v2 + v3: always point at the latest JSON files directly
    const mobileHref = `https://blog.clearroundtravel.com/schedule/data/schedule_mobile_v2.html?data=${encodeURIComponent(LATEST_SCHEDULE_URL)}`;
    const watchHref  = `https://blog.clearroundtravel.com/schedule/data/schedule_mobile_v3.html?data=${encodeURIComponent(LATEST_TEAM_URL)}`;

    document.getElementById("btnPrinted").href = printedHref;
    document.getElementById("btnMobile").href = mobileHref;
    document.getElementById("btnWatch").href = watchHref;
  }

  function setPublishedMeta(scheduleLastMs, teamLastMs){
    // Printed - Schedule: published only (from schedule)
    if(scheduleLastMs){
      setSub("subPrinted", `published: ${fmtTime(scheduleLastMs)}`);
      setSub("subMobile", `published: ${fmtTime(scheduleLastMs)} ‚Ä¢ next: ${fmtTime(scheduleLastMs + PUBLISH_INTERVAL_MS)}`);
    }else{
      setSub("subPrinted", "");
      setSub("subMobile", "");
    }

    // Mobile - Watch: published + next (from team)
    if(teamLastMs){
      setSub("subWatch", `published: ${fmtTime(teamLastMs)} ‚Ä¢ next: ${fmtTime(teamLastMs + PUBLISH_INTERVAL_MS)}`);
    }else{
      setSub("subWatch", "");
    }
  }

  (async function main(){
    startClock();

    // Load latest schedule + published time
    let scheduleRows = null;
    let scheduleLastMs = null;

    try{
      const r = await fetchJsonAndLastModified(LATEST_SCHEDULE_URL);
      scheduleRows = r.json;
      scheduleLastMs = r.lastModifiedMs;
    }catch(e){
      // keep going
    }

    // Load latest team + published time
    let teamLastMs = null;
    try{
      const r2 = await fetchJsonAndLastModified(LATEST_TEAM_URL);
      teamLastMs = r2.lastModifiedMs;
    }catch(e){
      // keep going
    }

    setHeaderDateFromRows(scheduleRows);
    setLinksFromSchedule(scheduleRows);
    setPublishedMeta(scheduleLastMs, teamLastMs);
  })();
</script>
</body>
</html>
